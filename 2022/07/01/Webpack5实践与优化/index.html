<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Webpack5实践与优化 | YolkPie</title><meta name="description" content="Webpack5简单介绍Webpack 5 发布于 2020年10月10日，Webpack 5 对Node.js 的版本要求至少是10.13.0 (LTS)。有以下特点：  尝试用持久性缓存来提高构建性能。  尝试用更好的算法和默认值来改进长期缓存。  尝试用更好的 Tree Shaking 和代码生成来改善包大小。  尝试改善与网络平台的兼容性。  尝试在不引入任何破坏性变化的情况下，清理那些在"><meta name="keywords" content="前端技术博客"><meta name="author" content="YolkPie"><meta name="copyright" content="YolkPie"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://yolkpie.net/2022/07/01/Webpack5%E5%AE%9E%E8%B7%B5%E4%B8%8E%E4%BC%98%E5%8C%96/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="Webpack5实践与优化"><meta property="og:url" content="https://yolkpie.net/2022/07/01/Webpack5%E5%AE%9E%E8%B7%B5%E4%B8%8E%E4%BC%98%E5%8C%96/"><meta property="og:site_name" content="YolkPie"><meta property="og:description" content="Webpack5简单介绍Webpack 5 发布于 2020年10月10日，Webpack 5 对Node.js 的版本要求至少是10.13.0 (LTS)。有以下特点：  尝试用持久性缓存来提高构建性能。  尝试用更好的算法和默认值来改进长期缓存。  尝试用更好的 Tree Shaking 和代码生成来改善包大小。  尝试改善与网络平台的兼容性。  尝试在不引入任何破坏性变化的情况下，清理那些在"><meta property="og:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><meta property="article:published_time" content="2022-07-01T02:00:00.000Z"><meta property="article:modified_time" content="2022-06-29T06:39:30.043Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="next" title="ES5和ES6的继承" href="https://yolkpie.net/2022/06/27/ES5%E5%92%8CES6%E7%9A%84%E7%BB%A7%E6%89%BF/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: false,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true
  }</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 5.0.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">167</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">84</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">35</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Webpack5%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">Webpack5简单介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E8%B7%B5"><span class="toc-number">2.</span> <span class="toc-text">实践</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.</span> <span class="toc-text">基础配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B%E6%96%B0%E5%BB%BA"><span class="toc-number">2.1.1.</span> <span class="toc-text">开始新建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">2.1.2.</span> <span class="toc-text">安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#node%EF%BC%88%E7%89%88%E6%9C%AC%E6%9C%89%E8%A6%81%E6%B1%82%EF%BC%89"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">node（版本有要求）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#webpack"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">webpack</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B0%E5%BB%BA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">2.1.2.3.</span> <span class="toc-text">新建配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#webpack-merge"><span class="toc-number">2.1.2.3.1.</span> <span class="toc-text">webpack-merge</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A5%E5%8F%A3%EF%BC%88entry%EF%BC%89"><span class="toc-number">2.1.2.4.</span> <span class="toc-text">入口（entry）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BE%93%E5%87%BA%EF%BC%88output"><span class="toc-number">2.1.2.5.</span> <span class="toc-text">输出（output)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%BC%8F%EF%BC%88mode%EF%BC%89"><span class="toc-number">2.1.2.6.</span> <span class="toc-text">模式（mode）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Source-Map"><span class="toc-number">2.1.2.7.</span> <span class="toc-text">Source Map</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HtmlWebpackPlugin"><span class="toc-number">2.1.2.8.</span> <span class="toc-text">HtmlWebpackPlugin</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DevServer"><span class="toc-number">2.1.2.9.</span> <span class="toc-text">DevServer</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">YolkPie</a></span><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">Webpack5实践与优化</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2022-07-01 10:00:00"><i class="far fa-calendar-alt fa-fw"></i> 发表于 2022-07-01</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2022-06-29 14:39:30"><i class="fas fa-history fa-fw"></i> 更新于 2022-06-29</span></time></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta__icon"></i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="Webpack5简单介绍"><a href="#Webpack5简单介绍" class="headerlink" title="Webpack5简单介绍"></a>Webpack5简单介绍</h1><p>Webpack 5 发布于 2020年10月10日，Webpack 5 对Node.js 的版本要求至少是10.13.0 (LTS)。<br>有以下特点：</p>
<ul>
<li><p>尝试用持久性缓存来提高构建性能。</p>
</li>
<li><p>尝试用更好的算法和默认值来改进长期缓存。</p>
</li>
<li><p>尝试用更好的 Tree Shaking 和代码生成来改善包大小。</p>
</li>
<li><p>尝试改善与网络平台的兼容性。</p>
</li>
<li><p>尝试在不引入任何破坏性变化的情况下，清理那些在实现 v4 功能时处于奇怪状态的内部结构。</p>
<blockquote>
<p>持久化缓存是 webpack5 所带来的非常强大的特性之一。一句话概括就是构建结果持久化缓存到本地的磁盘，二次构建(非 watch 模块)直接利用磁盘缓存的结果从而跳过构建过程当中的 resolve、build 等耗时的流程，从而大大提升编译构建的效率。</p>
</blockquote>
</li>
</ul>
<h1 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h1><h2 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h2><p>接下来一起配置一个的 Webpack5示例项目。<br>将支持以下功能：</p>
<ul>
<li>分离开发环境、生产环境配置；</li>
<li>模块化开发；</li>
<li>sourceMap 定位警告和错误；</li>
<li>动态生成引入 bundle.js 的 HTML5 文件；</li>
<li>实时编译；</li>
<li>封装编译、打包命令。</li>
</ul>
<h3 id="开始新建"><a href="#开始新建" class="headerlink" title="开始新建"></a>开始新建</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 初始化项目</span><br><span class="line">npm init -y</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 创建 src 文件夹</span><br><span class="line">mkdir src</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 创建 js文件</span><br><span class="line">touch index.js</span><br><span class="line">touch hello.js</span><br></pre></td></tr></table></figure>

<p>index.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import &#39;.&#x2F;hello.js&#39;</span><br><span class="line"></span><br><span class="line">console.log(&#39;index&#39;)</span><br></pre></td></tr></table></figure>

<p>hello.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">console.log(&#39;hello webpack&#39;)</span><br></pre></td></tr></table></figure>

<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><h4 id="node（版本有要求）"><a href="#node（版本有要求）" class="headerlink" title="node（版本有要求）"></a>node（版本有要求）</h4><h4 id="webpack"><a href="#webpack" class="headerlink" title="webpack"></a>webpack</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install webpack webpack-cli --save-dev</span><br></pre></td></tr></table></figure>
<h4 id="新建配置文件"><a href="#新建配置文件" class="headerlink" title="新建配置文件"></a>新建配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 创建 config 目录</span><br><span class="line">mkdir config</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 进入 config 目录</span><br><span class="line">cd .&#x2F;config</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 创建通用环境配置文件</span><br><span class="line">touch webpack.common.js</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 创建开发环境配置文件</span><br><span class="line">touch webpack.dev.js</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 创建生产环境配置文件</span><br><span class="line">touch webpack.prod.js</span><br></pre></td></tr></table></figure>
<h5 id="webpack-merge"><a href="#webpack-merge" class="headerlink" title="webpack-merge"></a>webpack-merge</h5><p>使用 webpack-marge 合并通用配置和特定环境配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 安装</span><br><span class="line">npm i webpack-merge -D</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; webpack.common.js通用环境配置</span><br><span class="line">module.exports &#x3D; &#123;&#125; &#x2F;&#x2F; 暂不添加配置</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; webpack.dev.js开发环境配置</span><br><span class="line">const &#123; merge &#125; &#x3D; require(&#39;webpack-merge&#39;)</span><br><span class="line">const common &#x3D; require(&#39;.&#x2F;webpack.common&#39;)</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; merge(common, &#123;&#125;) &#x2F;&#x2F; 暂不添加配置</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; webpack.prod.js生产环境配置</span><br><span class="line">const &#123; merge &#125; &#x3D; require(&#39;webpack-merge&#39;)</span><br><span class="line">const common &#x3D; require(&#39;.&#x2F;webpack.common&#39;)</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; merge(common, &#123;&#125;) &#x2F;&#x2F; 暂不添加配置</span><br></pre></td></tr></table></figure>
<h4 id="入口（entry）"><a href="#入口（entry）" class="headerlink" title="入口（entry）"></a>入口（entry）</h4><p>入口起点(entry point) 指示 webpack 应该使用哪个模块来作为构建其内部依赖图(dependency graph) 的开始。进入入口起点后，webpack会找出有哪些模块和库是入口起点（直接和间接）依赖的。</p>
<p>在此例中，使用 src/index.js 作为项目入口，webpack 以 src/index.js 为起点，查找所有依赖的模块。<br>修改 webpack.commom.js：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; merge(common, &#123;</span><br><span class="line">  &#x2F;&#x2F; 入口</span><br><span class="line">  entry: &#123;</span><br><span class="line">    index: &#39;.&#x2F;src&#x2F;index.js&#39;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="输出（output"><a href="#输出（output" class="headerlink" title="输出（output)"></a>输出（output)</h4><p>输出（output)告诉 webpack 在哪里输出它所创建的 bundle，以及如何命名这些文件。</p>
<p>生产环境的 output 需要通过 contenthash 值来区分版本和变动，可达到清缓存的效果，而本地环境为了构建效率，则不引人 contenthash。</p>
<p>新增 paths.js，封装路径方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">const fs &#x3D; require(&#39;fs&#39;)</span><br><span class="line">const path &#x3D; require(&#39;path&#39;)</span><br><span class="line"></span><br><span class="line">const appDirectory &#x3D; fs.realpathSync(process.cwd());</span><br><span class="line">const resolveApp &#x3D; relativePath &#x3D;&gt; path.resolve(appDirectory, relativePath);</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  resolveApp</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改开发环境配置文件 webpack.dev.js：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D;  merge(common, &#123;</span><br><span class="line">  &#x2F;&#x2F; 输出</span><br><span class="line">  output: &#123;</span><br><span class="line">    &#x2F;&#x2F; bundle 文件名称</span><br><span class="line">    filename: &#39;[name].bundle.js&#39;,</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; bundle 文件路径</span><br><span class="line">    path: resolveApp(&#39;dist&#39;),</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 编译前清除目录</span><br><span class="line">    clean: true</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>修改生产环境配置文件 webpack.prod.js：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D;  merge(common, &#123;</span><br><span class="line">  &#x2F;&#x2F; 输出</span><br><span class="line">  output: &#123;</span><br><span class="line">    &#x2F;&#x2F; bundle 文件名称 【只有这里和开发环境不一样】</span><br><span class="line">    filename: &#39;[name].[contenthash].bundle.js&#39;,</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; bundle 文件路径</span><br><span class="line">    path: resolveApp(&#39;dist&#39;),</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 编译前清除目录</span><br><span class="line">    clean: true</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上述 filename 的占位符解释如下</p>
</blockquote>
<ul>
<li>[name] - chunk name（例如 [name].js -&gt; app.js）。如果 chunk 没有名称，则会使用其 id 作为名称</li>
<li>[contenthash] - 输出文件内容的 md4-hash（例如 [contenthash].js -&gt; 4ea6ff1de66c537eb9b2.js）</li>
</ul>
<h4 id="模式（mode）"><a href="#模式（mode）" class="headerlink" title="模式（mode）"></a>模式（mode）</h4><p>通过 mode 配置选项，告知 webpack 使用相应模式的内置优化。<br>|选项|描述|<br>|-|-|<br>|development|会将 DefinePlugin 中 process.env.NODE_ENV 的值设置为 development. 为模块和 chunk 启用有效的名。|<br>|production|会将 DefinePlugin 中 process.env.NODE_ENV 的值设置为 production。为模块和 chunk 启用确定性的混淆名称。|</p>
<p>修改开发环境配置文件 webpack.dev.js：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D;  merge(common, &#123;</span><br><span class="line">  &#x2F;&#x2F; 开发模式</span><br><span class="line">  mode: &#39;development&#39;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>修改开发环境配置文件 webpack.prod.js：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D;  merge(common, &#123;</span><br><span class="line">  &#x2F;&#x2F; 生产模式</span><br><span class="line">  mode: &#39;production&#39;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="Source-Map"><a href="#Source-Map" class="headerlink" title="Source Map"></a>Source Map</h4><p>当 webpack 打包源代码时，可能会很难追踪到 error 和 warning 在源代码中的原始位置。</p>
<p>为了更容易地追踪 error 和 warning， source map 可以将编译后的代码映射回原始源代码。</p>
<p>修改开发环境配置文件 webpack.dev.js：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D;  merge(common, &#123;</span><br><span class="line">  &#x2F;&#x2F; 开发工具，开启 source map，编译调试</span><br><span class="line">  devtool: &#39;eval-cheap-module-source-map&#39;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>source map 还有许多其他 <a target="_blank" rel="noopener" href="https://webpack.docschina.org/configuration/devtool">可用选项</a> </p>
<blockquote>
<p>一般来说，为加快生产环境打包速度，不为生产环境配置 devtool。</p>
</blockquote>
<h4 id="HtmlWebpackPlugin"><a href="#HtmlWebpackPlugin" class="headerlink" title="HtmlWebpackPlugin"></a>HtmlWebpackPlugin</h4><p><code>npx webpack --config config/webpack.prod.js</code> 后生成了 bundle.js，我们需要一个 HTML5 文件，用来动态引入打包生成的 bundle 文件。</p>
<p>引入 HtmlWebpackPlugin 插件，生成一个 HTML5 文件， 其中包括使用 script 标签的 body 中的所有 webpack 包。</p>
<ul>
<li><p>安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev html-webpack-plugin</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改通用环境配置文件 webpack.commom.js：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  plugins: [</span><br><span class="line">    &#x2F;&#x2F; 生成html，自动引入所有bundle</span><br><span class="line">    new HtmlWebpackPlugin(&#123;</span><br><span class="line">      title: &#39;release_v0&#39;,</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>执行 <code>npx webpack --config config/webpack.prod.js</code><br>生成了 index.html，动态引入了 bundle.js 文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"> &lt;head&gt;</span><br><span class="line">  &lt;meta charset&#x3D;&quot;utf-8&quot; &#x2F;&gt;</span><br><span class="line">  &lt;title&gt;release_v0&lt;&#x2F;title&gt;</span><br><span class="line">  &lt;meta name&#x3D;&quot;viewport&quot; content&#x3D;&quot;width&#x3D;device-width,initial-scale&#x3D;1&quot; &#x2F;&gt;</span><br><span class="line">  &lt;script defer&#x3D;&quot;defer&quot; src&#x3D;&quot;index.468d741515bfc390d1ac.bundle.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line"> &lt;&#x2F;head&gt;</span><br><span class="line"> &lt;body&gt;&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>
<h4 id="DevServer"><a href="#DevServer" class="headerlink" title="DevServer"></a>DevServer</h4><p>在每次编译代码时，手动运行 npx webpack –config config/webpack.prod.js 会显得很麻烦， webpack-dev-server 帮助我们在代码发生变化后自动编译代码。</p>
<p>webpack-dev-server 提供了一个基本的 web server，并且具有实时重新加载功能。</p>
<ul>
<li><p>安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev webpack-dev-server</span><br><span class="line">&#96;&#96;&#96;  </span><br><span class="line"></span><br><span class="line">- 修改开发环境配置文件 webpack.dev.js：</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<p>module.exports = merge(common, {<br>devServer: {<br>  // 告诉服务器从哪里提供内容，只有在你想要提供静态文件时才需要。<br>  contentBase: ‘./dist’,<br>},<br>})</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### 执行命令</span><br><span class="line">优化 webpack 的实时编译、打包编译指令。</span><br><span class="line">通过 cross-env 配置环境变量，区分开发环境和生产环境。</span><br><span class="line"></span><br><span class="line">- 安装</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<p>npm install –save-dev cross-env</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 修改 package.json：</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<p>{<br>  “scripts”: {</p>
<pre><code>  &quot;dev&quot;: &quot;cross-env NODE_ENV=development webpack serve --open --config config/webpack.dev.js&quot;,
  &quot;build&quot;: &quot;cross-env NODE_ENV=production webpack --config config/webpack.prod.js&quot;
&#125;,
</code></pre>
<p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">-  npm run dev：本地构建</span><br><span class="line">-  npm run build：生产打包</span><br><span class="line"></span><br><span class="line">以上我们完成了一个基于 webpack5 编译的支持模块化开发的简单项目。下面开始进阶配置。</span><br><span class="line"></span><br><span class="line">### 进阶配置</span><br><span class="line">在上述配置基础上，继续配置，以实现如下功能：</span><br><span class="line"></span><br><span class="line">- 加载图片；</span><br><span class="line">- 加载字体；</span><br><span class="line">- 加载 CSS；</span><br><span class="line">- 使用 SASS；</span><br><span class="line">- 使用 PostCSS，并自动为 CSS 规则添加前缀，解析最新的 CSS 语法，引入 css-modules 解决全局命名冲突问题；</span><br><span class="line">- 使用 React；</span><br><span class="line">- 使用 TypeScript。</span><br><span class="line"></span><br><span class="line">#### 加载图片</span><br><span class="line"></span><br><span class="line">在 webpack 5 中，可以使用内置的 [资源模块（Asset Modules）](https:&#x2F;&#x2F;webpack.docschina.org&#x2F;guides&#x2F;asset-modules&#x2F;) ，将 images 图像混入我们的系统中。</span><br><span class="line"></span><br><span class="line">修改通用环境配置文件 webpack.commom.js：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>const { resolveApp } = require(‘./paths’);<br>module.exports = {<br>  module: {</p>
<pre><code>  rules: [
    &#123;
      test: /\.(png|svg|jpg|jpeg|gif)$/i,
      include: [
        resolveApp(&#39;src&#39;),
      ],
      type: &#39;asset/resource&#39;,
    &#125;,
  ],
&#125;,
</code></pre>
<p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### 加载字体（Font）</span><br><span class="line">使用 [资源模块（Asset Modules）](https:&#x2F;&#x2F;webpack.docschina.org&#x2F;guides&#x2F;asset-modules&#x2F;)  接收字体文件。</span><br><span class="line"></span><br><span class="line">修改通用环境配置文件 webpack.commom.js：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>module.exports = {<br>  module: {</p>
<pre><code>  rules: [
      &#123;
         test: /.(woff|woff2|eot|ttf|otf)$/i,
         include: [
            resolveApp(&#39;src&#39;),
          ],
         type: &#39;asset/resource&#39;,
       &#125;,
   ]
</code></pre>
<p>   }<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### 加载 CSS</span><br><span class="line"></span><br><span class="line">##### style-loader</span><br><span class="line">style-loader 用于将 CSS 插入到 DOM 中，通过使用多个 &lt;style&gt;&lt;&#x2F;style&gt; 自动把 styles 插入到 DOM 中.</span><br><span class="line"></span><br><span class="line">##### css-loader</span><br><span class="line">css-loader 对 @import 和 url() 进行处理，就像 js 解析 import&#x2F;require() 一样，让 CSS 也能模块化开发。</span><br><span class="line"></span><br><span class="line">- 安装相关依赖：</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<p>npm install –save-dev style-loader css-loader</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 修改通用环境配置文件 webpack.commom.js：</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<p>module.exports = {<br>  module: {</p>
<pre><code>  rules: [
      &#123;
          test: /\.css$/,
          include: paths.appSrc,
          use: [
            // 将 JS 字符串生成为 style 节点
            &#39;style-loader&#39;,
            // 将 CSS 转化成 CommonJS 模块
            &#39;css-loader&#39;,
          ],
        &#125;,
    ]
&#125;
</code></pre>
<p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### 使用 SASS</span><br><span class="line">##### Sass</span><br><span class="line">Sass 是一款强化 CSS 的辅助工具，它在 CSS 语法的基础上增加了变量、嵌套、混合、导入等高级功能。</span><br><span class="line">##### sass-loader</span><br><span class="line">sass-loader 加载 Sass&#x2F;SCSS 文件并将他们编译为 CSS。</span><br><span class="line"></span><br><span class="line">- 安装相关依赖：</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<p>npm install –save-dev sass-loader sass</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 修改通用环境配置文件 webpack.commom.js：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>module.exports = {<br>  module: {</p>
<pre><code>  rules: [
  &#123;
  test: /.(scss|sass)$/,
  include: paths.appSrc,
  use: [
    // 将 JS 字符串生成为 style 节点
    &#39;style-loader&#39;,
    // 将 CSS 转化成 CommonJS 模块
    &#39;css-loader&#39;,
    // 将 Sass 编译成 CSS
    &#39;sass-loader&#39;,
  ],
&#125;,
</code></pre>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### 使用 PostCSS</span><br><span class="line">##### PostCSS</span><br><span class="line">PostCSS 是一个用 JavaScript 工具和插件转换 CSS 代码的工具。</span><br><span class="line">- 可以自动为 CSS 规则添加前缀；</span><br><span class="line">- 将最新的 CSS 语法转换成大多数浏览器都能理解的语法；</span><br><span class="line">- css-modules 解决全局命名冲突问题。</span><br><span class="line"></span><br><span class="line">##### postcss-loader</span><br><span class="line">postcss-loader 使用 PostCSS 处理 CSS 的 loader。</span><br><span class="line"></span><br><span class="line">- 安装相关依赖</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<p>npm install –save-dev postcss-loader postcss postcss-preset-env</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 修改通用环境配置文件 webpack.commom.js：</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<p>const { resolveApp } = require(‘./paths’);<br>module.exports = {<br>  module: {</p>
<pre><code>  rules: [
    &#123;
      test: /\.module\.(scss|sass)$/,
      include: paths.appSrc,
      use: [
        // 将 JS 字符串生成为 style 节点
        &#39;style-loader&#39;,
        // 将 CSS 转化成 CommonJS 模块
        &#123;
          loader: &#39;css-loader&#39;,
          options: &#123;
            // Enable CSS Modules features
            modules: true,
            importLoaders: 2,
            // 0 =&gt; no loaders (default);
            // 1 =&gt; postcss-loader;
            // 2 =&gt; postcss-loader, sass-loader
          &#125;,
        &#125;,
        // 将 PostCSS 编译成 CSS
        &#123;
          loader: &#39;postcss-loader&#39;,
          options: &#123;
            postcssOptions: &#123;
              plugins: [
                [
                  // postcss-preset-env 包含 autoprefixer
                  &#39;postcss-preset-env&#39;,
                ],
              ],
            &#125;,
          &#125;,
        &#125;,
        // 将 Sass 编译成 CSS
        &#39;sass-loader&#39;,
      ],
    &#125;,
  ],
&#125;,
</code></pre>
<p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&gt; 为提升构建效率，为 loader 指定 include，通过使用 include 字段，仅将 loader 应用在实际需要将其转换的模块。</span><br><span class="line"></span><br><span class="line">#### 使用 React + TypeScript</span><br><span class="line"></span><br><span class="line">- 安装 React 相关</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<p>npm i react react-dom @types/react @types/react-dom -D</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 安装 TypeScript 相关：</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<p>npm i -D typescript esbuild-loader</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&gt; 为提高性能，摒弃了传统的 ts-loader，选择最新的 esbuild-loader。</span><br><span class="line"></span><br><span class="line">- 修改通用环境配置文件 webpack.commom.js：</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<p>module.exports = {<br>  resolve: {</p>
<pre><code>  extensions: [&#39;.tsx&#39;, &#39;.ts&#39;, &#39;.js&#39;],
</code></pre>
<p>  },<br>  module: {</p>
<pre><code>  rules: [
      &#123;
          test: /\.(js|ts|jsx|tsx)$/,
          include: paths.appSrc,
          use: [
            &#123;
              loader: &#39;esbuild-loader&#39;,
              options: &#123;
                loader: &#39;tsx&#39;,
                target: &#39;es2015&#39;,
              &#125;,
            &#125;
          ]
        &#125;,
   ]
</code></pre>
<p>   }<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">TypeScript 是 JavaScript 的超集，为其增加了类型系统，可以编译为普通 JavaScript 代码。</span><br><span class="line"></span><br><span class="line">为兼容 TypeScript 文件，新增 typescript 配置文件 tsconfig.json：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>{<br>  “compilerOptions”: {</p>
<pre><code>  &quot;outDir&quot;: &quot;./dist/&quot;,
  &quot;noImplicitAny&quot;: true,
  &quot;module&quot;: &quot;es6&quot;,
  &quot;target&quot;: &quot;es5&quot;,
  &quot;jsx&quot;: &quot;react&quot;,
  &quot;allowJs&quot;: true,
  &quot;moduleResolution&quot;: &quot;node&quot;,
  &quot;allowSyntheticDefaultImports&quot;: true,
  &quot;esModuleInterop&quot;: true,
&#125;
</code></pre>
<p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 优化</span><br><span class="line">- 开发体验</span><br><span class="line">- 加快编译速度</span><br><span class="line">- 减小打包体积</span><br><span class="line"></span><br><span class="line">## 开发体验</span><br><span class="line"></span><br><span class="line">### 自动更新</span><br><span class="line"></span><br><span class="line">自动更新：在开发过程中，修改代码后，无需手动再次编译，可以自动编译代码更新编译后代码的功能。</span><br><span class="line"></span><br><span class="line">webpack5 提供了以下几种可选方式，来实现自动更新功能：</span><br><span class="line"></span><br><span class="line">- [webpack&#39;s Watch Mode](https:&#x2F;&#x2F;webpack.docschina.org&#x2F;configuration&#x2F;watch&#x2F;#watch)</span><br><span class="line">- [webpack-dev-server](https:&#x2F;&#x2F;github.com&#x2F;webpack&#x2F;webpack-dev-server)</span><br><span class="line">- [webpack-dev-middleware](https:&#x2F;&#x2F;github.com&#x2F;webpack&#x2F;webpack-dev-middleware)</span><br><span class="line">官方推荐的方式是 webpack-dev-server，前面已经介绍了 webpack-dev-server 帮助我们在代码发生变化后自动编译代码实现自动更新的用法，在这里不重复赘述。</span><br><span class="line"></span><br><span class="line">### 热更新</span><br><span class="line"></span><br><span class="line">热更新：在开发过程中，修改代码后，仅更新修改部分的内容，无需刷新整个页面。</span><br><span class="line"></span><br><span class="line">#### 修改 webpack-dev-server 配置</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>module.export = {<br>  devServer: {</p>
<pre><code>  contentBase: &#39;./dist&#39;,
  hot: true, // 热更新
&#125;,
</code></pre>
<p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### 引入 react-refresh-webpack-plugin</span><br><span class="line"></span><br><span class="line">- 安装</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<p>npm install -D @pmmmwh/react-refresh-webpack-plugin react-refresh</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 修改 webpack.dev.js 配置：</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<p>const ReactRefreshWebpackPlugin = require(‘@pmmmwh/react-refresh-webpack-plugin’);</p>
</li>
</ul>
<p>module.exports = {<br>    plugins: [<br>        new webpack.HotModuleReplacementPlugin(),<br>        new ReactRefreshWebpackPlugin(),<br>    ]<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### 加快构建速度</span><br><span class="line"></span><br><span class="line">webpack5 较于 webpack4，新增了&lt;font color&#x3D;&quot;red&quot;&gt;持久化缓存、改进缓存算法&lt;&#x2F;font&gt;等优化，较之前版本构建速度已有不错的提升。</span><br><span class="line"></span><br><span class="line">#### cache</span><br><span class="line"></span><br><span class="line">通过配置 [webpack 持久化缓存](https:&#x2F;&#x2F;webpack.docschina.org&#x2F;configuration&#x2F;cache&#x2F;#root) cache: filesystem，来缓存生成的 webpack 模块和 chunk，改善构建速度。</span><br><span class="line"></span><br><span class="line">简单来说，通过 cache: filesystem 可以将构建过程的 webpack 模板进行缓存，大幅提升二次构建速度、打包速度，当构建突然中断，二次进行构建时，可以直接从缓存中拉取，因而提升构建速度。</span><br><span class="line"></span><br><span class="line">#### 减少 loader、plugins</span><br><span class="line"></span><br><span class="line">为 loader 指定 include，减少 loader 应用范围，仅应用于最少数量的必要模块，来提升[webpack构建性能](https:&#x2F;&#x2F;webpack.docschina.org&#x2F;guides&#x2F;build-performance&#x2F;)</span><br><span class="line"></span><br><span class="line">webpack.common.js 配置方式如下：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>module.exports = {<br>    rules: [<br>        {<br>            test: /.(js|ts|jsx|tsx)$/,<br>            include: paths.appSrc,<br>            use: [<br>              {<br>                loader: ‘esbuild-loader’,<br>                options: {<br>                  loader: ‘tsx’,<br>                  target: ‘es2015’,<br>                },<br>              }<br>            ]<br>         }<br>    ]<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&gt; rule.exclude 可以排除模块范围，也可用于减少 loader 应用范围。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##### 管理资源</span><br><span class="line"></span><br><span class="line">使用 webpack 资源模块 (asset module) 代替旧的 assets loader（如 file-loader&#x2F;url-loader&#x2F;raw-loader 等），减少 loader 配置数量。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>module.exports = {<br>    rules: [<br>       {<br>        test: /.(png|svg|jpg|jpeg|gif)$/i,<br>        include: [<br>          paths.appSrc,<br>        ],<br>        type: ‘asset/resource’,<br>      },<br>    ]<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### 优化 resolve 配置</span><br><span class="line">[resolve](https:&#x2F;&#x2F;webpack.docschina.org&#x2F;configuration&#x2F;resolve&#x2F;#root) 用来配置 webpack 如何解析模块，可通过优化 resolve 配置来覆盖默认配置项，减少解析范围。</span><br><span class="line"></span><br><span class="line">##### alias</span><br><span class="line">alias 可以创建 import 或 require 的别名，用来简化模块引入。</span><br><span class="line">webpack.common.js 配置方式如下：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>module.exports = {<br>    resolve: {<br>        alias: {<br>          ‘@’: paths.appSrc, // @ 代表 src 路径<br>        },<br>    }<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">##### extensions</span><br><span class="line">extensions 表示需要解析的文件类型列表。</span><br><span class="line"></span><br><span class="line">根据项目中的文件类型，定义 extensions，以覆盖 webpack 默认的 extensions，加快解析速度。</span><br><span class="line"></span><br><span class="line">由于 &lt;font color&#x3D;&#39;red&#39;&gt;webpack 的解析顺序是从左到右&lt;&#x2F;font&gt;，因此要将使用频率高的文件类型放在左侧，如下我将 tsx 放在最左侧。</span><br><span class="line"></span><br><span class="line">webpack.common.js 配置方式如下：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>module.exports = {<br>    resolve: {<br>        extensions: [‘.tsx’, ‘.js’], // 这里只是举例，如果有其他类型，需要按顺序添加进去。<br>    }<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### modules</span><br><span class="line">modules 表示 webpack 解析模块时需要解析的目录。</span><br><span class="line"></span><br><span class="line">指定目录可缩小 webpack 解析范围，加快构建速度。</span><br><span class="line">webpack.common.js 配置方式如下：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>module.exports = {<br>    modules: [<br>      ‘node_modules’, //这里只是举例说明<br>       paths.appSrc,<br>    ]<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### thread-loader</span><br><span class="line">通过 [thread-loader](https:&#x2F;&#x2F;webpack.docschina.org&#x2F;loaders&#x2F;thread-loader&#x2F;#root) 将耗时的 loader 放在一个独立的 worker 池中运行，加快 loader 构建速度。</span><br><span class="line"></span><br><span class="line">- 安装：</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<p>npm i -D thread-loader</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">webpack.common.js 配置方式如下：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>module.exports = {<br>    rules: [<br>        {<br>        test: /.module.(scss|sass)$/,<br>        include: paths.appSrc,<br>        use: [<br>          ‘style-loader’,<br>          {<br>            loader: ‘css-loader’,<br>            options: {<br>              modules: true,<br>              importLoaders: 2,<br>            },<br>          },<br>          {<br>            loader: ‘postcss-loader’,<br>            options: {<br>              postcssOptions: {<br>                plugins: [<br>                  [<br>                    ‘postcss-preset-env’,<br>                  ],<br>                ],<br>              },<br>            },<br>          },<br>          {<br>            loader: ‘thread-loader’,<br>            options: {<br>              workerParallelJobs: 2<br>            }<br>          },<br>          ‘sass-loader’,<br>        ].filter(Boolean),<br>      },<br>    ]<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&gt; webpack 官网 提到 node-sass 中有个来自 Node.js 线程池的阻塞线程的 bug。 当使用 thread-loader 时，需要设置 workerParallelJobs: 2。</span><br><span class="line"></span><br><span class="line">&gt; 应该仅在非常耗时的 loader 前引入 thread-loader，如果代码量比较小，滥用thread-loader，反而会影响构建速度。</span><br><span class="line"></span><br><span class="line">### 减小打包体积</span><br><span class="line"></span><br><span class="line">#### 代码压缩</span><br><span class="line">通过 webpack 插件，将 JS、CSS 等文件进行压缩。</span><br><span class="line">##### JS 压缩</span><br><span class="line"></span><br><span class="line">使用 [TerserWebpackPlugin](https:&#x2F;&#x2F;webpack.docschina.org&#x2F;plugins&#x2F;terser-webpack-plugin&#x2F;) 来压缩 JavaScript。</span><br><span class="line"></span><br><span class="line">webpack5 自带最新的 terser-webpack-plugin，无需手动安装。</span><br><span class="line"></span><br><span class="line">&gt; terser-webpack-plugin 默认开启了 parallel: true 配置，并发运行的默认数量： os.cpus().length - 1 ，本文配置的 parallel 数量为 4，使用多进程并发运行压缩以提高构建速度。</span><br><span class="line"></span><br><span class="line">webpack.prod.js 配置方式如下：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>const TerserPlugin = require(‘terser-webpack-plugin’);<br>module.exports = {<br>    optimization: {<br>        minimizer: [<br>            new TerserPlugin({<br>              parallel: 4,<br>              terserOptions: {<br>                parse: {<br>                  ecma: 8,<br>                },<br>                compress: {<br>                  ecma: 5,<br>                  warnings: false,<br>                  comparisons: false,<br>                  inline: 2,<br>                },<br>                mangle: {<br>                  safari10: true,<br>                },<br>                output: {<br>                  ecma: 5,<br>                  comments: false,<br>                  ascii_only: true,<br>                },<br>              },<br>            }),<br>        ]<br>    }<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">##### CSS 压缩</span><br><span class="line"></span><br><span class="line">使用 [CssMinimizerWebpackPlugin](https:&#x2F;&#x2F;webpack.docschina.org&#x2F;plugins&#x2F;css-minimizer-webpack-plugin&#x2F;#root) 压缩 CSS 文件。</span><br><span class="line"></span><br><span class="line">- 安装</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<p>npm install -D css-minimizer-webpack-plugin</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- webpack.prod.js 配置方式如下：</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<p>const CssMinimizerPlugin = require(“css-minimizer-webpack-plugin”);</p>
<p>module.exports = {<br>  optimization: {<br>    minimizer: [<br>      new CssMinimizerPlugin({<br>          parallel: 4,<br>        }),<br>    ],<br>  }<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### 代码分离</span><br><span class="line"></span><br><span class="line">代码分离能够把代码分离到不同的 bundle 中，然后可以按需加载或并行加载这些文件。</span><br><span class="line"></span><br><span class="line">##### 抽离重复代码</span><br><span class="line"></span><br><span class="line">[SplitChunksPlugin](https:&#x2F;&#x2F;webpack.docschina.org&#x2F;plugins&#x2F;split-chunks-plugin) 插件，可以将公共的依赖模块提取到已有的入口 chunk 中，或者提取到一个新生成的 chunk。</span><br><span class="line"></span><br><span class="line">webpack 将根据以下条件自动拆分 chunks：</span><br><span class="line"></span><br><span class="line">- 新的 chunk 可以被共享，或者模块来自于 node_modules 文件夹；</span><br><span class="line">- 新的 chunk 体积大于 20kb（在进行 min+gz 之前的体积）；</span><br><span class="line">- 当按需加载 chunks 时，并行请求的最大数量小于或等于 30；</span><br><span class="line">- 当加载初始化页面时，并发请求的最大数量小于或等于 30； 通过 splitChunks 把 react 等公共库抽离出来，不重复引入占用体积。</span><br><span class="line"></span><br><span class="line">&gt; 注意：切记不要为 cacheGroups 定义固定的 name，因为  cacheGroups.name  指定字符串或始终返回相同字符串的函数时，会将所有常见模块和 vendor 合并为一个 chunk。这会导致更大的初始下载量并减慢页面加载速度。</span><br><span class="line"></span><br><span class="line">webpack.prod.js 配置方式如下：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>module.exports = {<br>    splitChunks: {<br>      // include all types of chunks<br>      chunks: ‘all’,<br>      // 重复打包问题<br>      cacheGroups:{<br>        vendors:{ // node_modules里的代码<br>          test: /[\/]node_modules[\/]/,<br>          chunks: “all”,<br>          // name: ‘vendors’, 一定不要定义固定的name<br>          priority: 10, // 优先级<br>          enforce: true<br>        }<br>      }<br>    },<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">这样即将公共的模块单独打包，不再重复引入了。</span><br><span class="line"></span><br><span class="line">##### CSS 文件分离</span><br><span class="line">如果 CSS 是放在 JS 文件中，[MiniCssExtractPlugin](https:&#x2F;&#x2F;webpack.docschina.org&#x2F;plugins&#x2F;mini-css-extract-plugin&#x2F;) 插件将 CSS 提取到单独的文件中，为每个包含 CSS 的 JS 文件创建一个 CSS 文件，并且支持 CSS 和 SourceMaps 的按需加载。</span><br><span class="line"></span><br><span class="line">- 安装：</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<p>npm install -D mini-css-extract-plugin</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- webpack.common.js 配置方式如下：</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<p>const MiniCssExtractPlugin = require(“mini-css-extract-plugin”);</p>
<p>module.exports = {<br>  plugins: [new MiniCssExtractPlugin()],<br>  module: {<br>    rules: [<br>        {<br>        test: /.module.(scss|sass)$/,<br>        include: paths.appSrc,<br>        use: [<br>          ‘style-loader’,<br>          isEnvProduction &amp;&amp; MiniCssExtractPlugin.loader, // 仅生产环境<br>          {<br>            loader: ‘css-loader’,<br>            options: {<br>              modules: true,<br>              importLoaders: 2,<br>            },<br>          },<br>          {<br>            loader: ‘postcss-loader’,<br>            options: {<br>              postcssOptions: {<br>                plugins: [<br>                  [<br>                    ‘postcss-preset-env’,<br>                  ],<br>                ],<br>              },<br>            },<br>          },<br>          {<br>            loader: ‘thread-loader’,<br>            options: {<br>              workerParallelJobs: 2<br>            }<br>          },<br>          ‘sass-loader’,<br>        ].filter(Boolean),<br>      },<br>    ]<br>  },<br>};</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&gt; 注意：MiniCssExtractPlugin.loader 一定要放在 style-loader 后面。</span><br><span class="line"></span><br><span class="line">#### 最小化 entry chunk</span><br><span class="line"></span><br><span class="line">通过配置 optimization.runtimeChunk &#x3D; true，为运行时代码创建一个额外的 chunk，减少 entry chunk 体积，提高性能。</span><br><span class="line"></span><br><span class="line">webpack.prod.js 配置方式如下：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>module.exports = {<br>    optimization: {<br>        runtimeChunk: true,<br>      },<br>    };<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### Tree Shaking（摇树） </span><br><span class="line">摇树，就是将枯黄的落叶摇下来，只留下树上活的叶子。枯黄的落叶代表项目中未引用的无用代码，活的树叶代表项目中实际用到的源码。</span><br><span class="line"></span><br><span class="line">##### JS</span><br><span class="line"></span><br><span class="line">[JS Tree Shaking](https:&#x2F;&#x2F;webpack.docschina.org&#x2F;guides&#x2F;tree-shaking&#x2F;) 将 JavaScript 上下文中的未引用代码（Dead Code）移除，通过 package.json 的 &quot;sideEffects&quot; 属性作为标记，向 compiler 提供提示，表明项目中的哪些文件是 &quot;pure(纯正 ES2015 模块)&quot;，由此可以安全地删除文件中未使用的部分。</span><br><span class="line"></span><br><span class="line">###### webpack5 sideEffects</span><br><span class="line">通过 package.json 的 &quot;sideEffects&quot; 属性，来实现这种方式。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>{<br>  “name”: “your-project”,<br>  “sideEffects”: false<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">需注意的是，当代码有副作用时，需要将 sideEffects 改为提供一个数组，添加有副作用代码的文件路径：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>{<br>  “name”: “your-project”,<br>  “sideEffects”: [“./src/some-side-effectful-file.js”]<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">##### CSS</span><br><span class="line"></span><br><span class="line">使用 [purgecss-webpack-plugin](https:&#x2F;&#x2F;github.com&#x2F;FullHuman&#x2F;purgecss&#x2F;tree&#x2F;main&#x2F;packages&#x2F;purgecss-webpack-plugin) 对 CSS Tree Shaking。</span><br><span class="line"></span><br><span class="line">- 安装：</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<p>npm i purgecss-webpack-plugin -D</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">因为打包时 CSS 默认放在 JS 文件内，因此要结合 webpack 分离 CSS 文件插件 mini-css-extract-plugin 一起使用，先将 CSS 文件分离，再进行 CSS Tree Shaking。</span><br><span class="line"></span><br><span class="line">webpack.prod.js 配置方式如下：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>const glob = require(‘glob’)<br>const MiniCssExtractPlugin = require(‘mini-css-extract-plugin’)<br>const PurgeCSSPlugin = require(‘purgecss-webpack-plugin’)<br>const paths = require(‘paths’)</p>
<p>module.exports = {<br>  plugins: [<br>    // 打包体积分析<br>    new BundleAnalyzerPlugin(),<br>    // 提取 CSS<br>    new MiniCssExtractPlugin({<br>      filename: “[name].css”,<br>    }),<br>    // CSS Tree Shaking<br>    new PurgeCSSPlugin({<br>      paths: glob.sync(<code>$&#123;paths.appSrc&#125;/**/*</code>,  { nodir: true }),<br>    }),<br>  ]<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 自定义插件</span><br><span class="line">插件向第三方开发者提供了 webpack 引擎中完整的能力。使用阶段式的构建回调，开发者可以在 webpack 构建流程中引入自定义的行为。</span><br><span class="line"></span><br><span class="line">### 创建插件</span><br><span class="line"></span><br><span class="line">webpack 插件由以下组成：</span><br><span class="line"></span><br><span class="line">- 一个 JavaScript 命名函数或 JavaScript 类。</span><br><span class="line">- 在插件函数的 prototype 上定义一个 apply 方法。</span><br><span class="line">- 指定一个绑定到 webpack 自身的事件钩子。</span><br><span class="line">- 处理 webpack 内部实例的特定数据。</span><br><span class="line">- 功能完成后调用 webpack 提供的回调。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>// 一个 JavaScript 类<br>class MyExampleWebpackPlugin {<br>  // 在插件函数的 prototype 上定义一个 <code>apply</code> 方法，以 compiler 为参数。<br>  apply(compiler) {<br>    // 指定一个挂载到 webpack 自身的事件钩子。<br>    compiler.hooks.emit.tapAsync(<br>      ‘MyExampleWebpackPlugin’,<br>      (compilation, callback) =&gt; {<br>        console.log(‘这是一个示例插件！’);<br>        console.log(<br>          ‘这里表示了资源的单次构建的 <code>compilation</code> 对象：’,<br>          compilation<br>        );</p>
<pre><code>    // 用 webpack 提供的插件 API 处理构建过程
    compilation.addModule(/* ... */);

    callback();
  &#125;
);
</code></pre>
<p>  }<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### 基本插件架构</span><br><span class="line">插件是由「具有 apply 方法的 prototype 对象」所实例化出来的。这个 apply 方法在安装插件时，会被 webpack compiler 调用一次。apply 方法可以接收一个 webpack compiler 对象的引用，从而可以在回调函数中访问到 compiler 对象。一个插件结构如下：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>class HelloWorldPlugin {<br>  apply(compiler) {<br>    compiler.hooks.done.tap(<br>      ‘Hello World Plugin’,<br>      (<br>        stats /* 绑定 done 钩子后，stats 会作为参数传入。 */<br>      ) =&gt; {<br>        console.log(‘Hello World!’);<br>      }<br>    );<br>  }<br>}</p>
<p>module.exports = HelloWorldPlugin;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">然后，要安装这个插件，只需要在你的 webpack 配置的 plugin 数组中添加一个实例：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>// webpack.config.js<br>var HelloWorldPlugin = require(‘hello-world’);</p>
<p>module.exports = {<br>  // … 这里是其他配置 …<br>  plugins: [new HelloWorldPlugin({ options: true })],<br>};</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### Compiler 和 Compilation</span><br><span class="line">在插件开发中最重要的两个资源就是 [compiler](https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_40409143&#x2F;article&#x2F;details&#x2F;123663207) 和 [compilation](https:&#x2F;&#x2F;blog.csdn.net&#x2F;weixin_34293911&#x2F;article&#x2F;details&#x2F;88675677) 对象。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>class HelloCompilationPlugin {<br>  apply(compiler) {<br>    // 指定一个挂载到 compilation 的钩子，回调函数的参数为 compilation 。<br>    compiler.hooks.compilation.tap(‘HelloCompilationPlugin’, (compilation) =&gt; {<br>      // 现在可以通过 compilation 对象绑定各种钩子<br>      compilation.hooks.optimize.tap(‘HelloCompilationPlugin’, () =&gt; {<br>        console.log(‘资源已经优化完毕。’);<br>      });<br>    });<br>  }<br>}</p>
<p>module.exports = HelloCompilationPlugin;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### 异步编译插件</span><br><span class="line">有些插件钩子是异步的。我们可以像同步方式一样用 tap 方法来绑定，也可以用 tapAsync 或 tapPromise 这两个异步方法来绑定。</span><br><span class="line">#### tapAsync</span><br><span class="line"></span><br><span class="line">当我们用 tapAsync 方法来绑定插件时，_必须_调用函数的最后一个参数 callback 指定的回调函数。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>class HelloAsyncPlugin {<br>  apply(compiler) {<br>    compiler.hooks.emit.tapAsync(<br>      ‘HelloAsyncPlugin’,<br>      (compilation, callback) =&gt; {<br>        // 执行某些异步操作…<br>        setTimeout(function () {<br>          console.log(‘异步任务完成…’);<br>          callback();<br>        }, 1000);<br>      }<br>    );<br>  }<br>}</p>
<p>module.exports = HelloAsyncPlugin;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### tapPromise</span><br><span class="line">当我们用 tapPromise 方法来绑定插件时，_必须_返回一个 pormise ，异步任务完成后 resolve 。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>class HelloAsyncPlugin {<br>  apply(compiler) {<br>    compiler.hooks.emit.tapPromise(‘HelloAsyncPlugin’, (compilation) =&gt; {<br>      // 返回一个 pormise ，异步任务完成后 resolve<br>      return new Promise((resolve, reject) =&gt; {<br>        setTimeout(function () {<br>          console.log(‘异步任务完成…’);<br>          resolve();<br>        }, 1000);<br>      });<br>    });<br>  }<br>}</p>
<p>module.exports = HelloAsyncPlugin;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### 示例</span><br><span class="line">一个简单的示例插件，生成一个叫做 assets.md 的新文件；文件内容是所有构建生成的文件的列表。这个插件大概像下面这样：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>class FileListPlugin {<br>  static defaultOptions = {<br>    outputFile: ‘assets.md’,<br>  };</p>
<p>  // 需要传入自定义插件构造函数的任意选项<br>  //（这是自定义插件的公开API）<br>  constructor(options = {}) {<br>    // 在应用默认选项前，先应用用户指定选项<br>    // 合并后的选项暴露给插件方法<br>    // 记得在这里校验所有选项<br>    this.options = { …FileListPlugin.defaultOptions, …options };<br>  }</p>
<p>  apply(compiler) {<br>    const pluginName = FileListPlugin.name;</p>
<pre><code>// webpack 模块实例，可以通过 compiler 对象访问，
// 这样确保使用的是模块的正确版本
// （不要直接 require/import webpack）
const &#123; webpack &#125; = compiler;

// Compilation 对象提供了对一些有用常量的访问。
const &#123; Compilation &#125; = webpack;

// RawSource 是其中一种 “源码”(&quot;sources&quot;) 类型，
// 用来在 compilation 中表示资源的源码
const &#123; RawSource &#125; = webpack.sources;

// 绑定到 “thisCompilation” 钩子，
// 以便进一步绑定到 compilation 过程更早期的阶段
compiler.hooks.thisCompilation.tap(pluginName, (compilation) =&gt; &#123;
  // 绑定到资源处理流水线(assets processing pipeline)
  compilation.hooks.processAssets.tap(
    &#123;
      name: pluginName,

      // 用某个靠后的资源处理阶段，
      // 确保所有资源已被插件添加到 compilation
      stage: Compilation.PROCESS_ASSETS_STAGE_SUMMARIZE,
    &#125;,
    (assets) =&gt; &#123;
      // &quot;assets&quot; 是一个包含 compilation 中所有资源(assets)的对象。
      // 该对象的键是资源的路径，
      // 值是文件的源码

      // 遍历所有资源，
      // 生成 Markdown 文件的内容
      const content =
        &#39;# In this build:\n\n&#39; +
        Object.keys(assets)
          .map((filename) =&gt; `- $&#123;filename&#125;`)
          .join(&#39;\n&#39;);

      // 向 compilation 添加新的资源，
      // 这样 webpack 就会自动生成并输出到 output 目录
      compilation.emitAsset(
        this.options.outputFile,
        new RawSource(content)
      );
    &#125;
  );
&#125;);
</code></pre>
<p>  }<br>}</p>
<p>module.exports = { FileListPlugin };</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<p>//webpack.config.js<br>const { FileListPlugin } = require(‘./file-list-plugin.js’);</p>
<p>// 在 webpack 配置中使用自定义的插件：<br>module.exports = {<br>  // …</p>
<p>  plugins: [<br>    // 添加插件，使用默认选项<br>    new FileListPlugin(),</p>
<pre><code>// 或者:

// 使用任意支持的选项
new FileListPlugin(&#123;
  outputFile: &#39;my-assets.md&#39;,
&#125;),
</code></pre>
<p>  ],<br>};</p>
<pre><code>
</code></pre>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">YolkPie</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://yolkpie.net/2022/07/01/Webpack5%E5%AE%9E%E8%B7%B5%E4%B8%8E%E4%BC%98%E5%8C%96/">https://yolkpie.net/2022/07/01/Webpack5%E5%AE%9E%E8%B7%B5%E4%B8%8E%E4%BC%98%E5%8C%96/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://yolkpie.net" target="_blank">YolkPie</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2022/06/27/ES5%E5%92%8CES6%E7%9A%84%E7%BB%A7%E6%89%BF/"><img class="next-cover" data-src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">ES5和ES6的继承</div></div></a></div></nav></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By YolkPie</div><div class="framework-info"><span>驱动 </span><a target="_blank" rel="noopener" href="https://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><button id="readmode" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" title="缩小字体"><i class="fas fa-minus"></i></button><button class="translate_chn_to_cht" id="translateLink" title="简繁转换">繁</button><button id="darkmode" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script></body></html>