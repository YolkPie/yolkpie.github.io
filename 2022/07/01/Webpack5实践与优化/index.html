<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Webpack5实践与优化 | YolkPie</title><meta name="description" content="Webpack5简单介绍Webpack 5 发布于 2020年10月10日，Webpack 5 对Node.js 的版本要求至少是10.13.0 (LTS)。有以下特点：  尝试用持久性缓存来提高构建性能。  尝试用更好的算法和默认值来改进长期缓存。  尝试用更好的 Tree Shaking 和代码生成来改善包大小。  尝试改善与网络平台的兼容性。  尝试在不引入任何破坏性变化的情况下，清理那些在"><meta name="keywords" content="前端技术博客"><meta name="author" content="YolkPie"><meta name="copyright" content="YolkPie"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://yolkpie.net/2022/07/01/Webpack5%E5%AE%9E%E8%B7%B5%E4%B8%8E%E4%BC%98%E5%8C%96/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="Webpack5实践与优化"><meta property="og:url" content="https://yolkpie.net/2022/07/01/Webpack5%E5%AE%9E%E8%B7%B5%E4%B8%8E%E4%BC%98%E5%8C%96/"><meta property="og:site_name" content="YolkPie"><meta property="og:description" content="Webpack5简单介绍Webpack 5 发布于 2020年10月10日，Webpack 5 对Node.js 的版本要求至少是10.13.0 (LTS)。有以下特点：  尝试用持久性缓存来提高构建性能。  尝试用更好的算法和默认值来改进长期缓存。  尝试用更好的 Tree Shaking 和代码生成来改善包大小。  尝试改善与网络平台的兼容性。  尝试在不引入任何破坏性变化的情况下，清理那些在"><meta property="og:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><meta property="article:published_time" content="2022-07-01T02:00:00.000Z"><meta property="article:modified_time" content="2022-07-01T05:41:48.682Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="prev" title="设计师培养设计思考能力" href="https://yolkpie.net/2022/07/01/%E8%AE%BE%E8%AE%A1%E5%B8%88%E5%9F%B9%E5%85%BB%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%80%83%E8%83%BD%E5%8A%9B/"><link rel="next" title="js内存" href="https://yolkpie.net/2022/06/29/JS%E5%86%85%E5%AD%98/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: false,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true
  }</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 5.0.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">172</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">84</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">35</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Webpack5%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">Webpack5简单介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E8%B7%B5"><span class="toc-number">2.</span> <span class="toc-text">实践</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.</span> <span class="toc-text">基础配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B%E6%96%B0%E5%BB%BA"><span class="toc-number">2.1.1.</span> <span class="toc-text">开始新建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">2.1.2.</span> <span class="toc-text">安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#node%EF%BC%88%E7%89%88%E6%9C%AC%E6%9C%89%E8%A6%81%E6%B1%82%EF%BC%89"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">node（版本有要求）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#webpack"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">webpack</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B0%E5%BB%BA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">2.1.2.3.</span> <span class="toc-text">新建配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#webpack-merge"><span class="toc-number">2.1.2.3.1.</span> <span class="toc-text">webpack-merge</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A5%E5%8F%A3%EF%BC%88entry%EF%BC%89"><span class="toc-number">2.1.2.4.</span> <span class="toc-text">入口（entry）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BE%93%E5%87%BA%EF%BC%88output"><span class="toc-number">2.1.2.5.</span> <span class="toc-text">输出（output)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%BC%8F%EF%BC%88mode%EF%BC%89"><span class="toc-number">2.1.2.6.</span> <span class="toc-text">模式（mode）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Source-Map"><span class="toc-number">2.1.2.7.</span> <span class="toc-text">Source Map</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HtmlWebpackPlugin"><span class="toc-number">2.1.2.8.</span> <span class="toc-text">HtmlWebpackPlugin</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DevServer"><span class="toc-number">2.1.2.9.</span> <span class="toc-text">DevServer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="toc-number">2.1.2.10.</span> <span class="toc-text">执行命令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E9%98%B6%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.3.</span> <span class="toc-text">进阶配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E5%9B%BE%E7%89%87"><span class="toc-number">2.1.3.1.</span> <span class="toc-text">加载图片</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E5%AD%97%E4%BD%93%EF%BC%88Font%EF%BC%89"><span class="toc-number">2.1.3.2.</span> <span class="toc-text">加载字体（Font）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD-CSS"><span class="toc-number">2.1.3.3.</span> <span class="toc-text">加载 CSS</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#style-loader"><span class="toc-number">2.1.3.3.1.</span> <span class="toc-text">style-loader</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#css-loader"><span class="toc-number">2.1.3.3.2.</span> <span class="toc-text">css-loader</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-SASS"><span class="toc-number">2.1.3.4.</span> <span class="toc-text">使用 SASS</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Sass"><span class="toc-number">2.1.3.4.1.</span> <span class="toc-text">Sass</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#sass-loader"><span class="toc-number">2.1.3.4.2.</span> <span class="toc-text">sass-loader</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-PostCSS"><span class="toc-number">2.1.3.5.</span> <span class="toc-text">使用 PostCSS</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#PostCSS"><span class="toc-number">2.1.3.5.1.</span> <span class="toc-text">PostCSS</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#postcss-loader"><span class="toc-number">2.1.3.5.2.</span> <span class="toc-text">postcss-loader</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-React-TypeScript"><span class="toc-number">2.1.3.6.</span> <span class="toc-text">使用 React + TypeScript</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BC%98%E5%8C%96"><span class="toc-number">3.</span> <span class="toc-text">优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E4%BD%93%E9%AA%8C"><span class="toc-number">3.1.</span> <span class="toc-text">开发体验</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0"><span class="toc-number">3.1.1.</span> <span class="toc-text">自动更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%83%AD%E6%9B%B4%E6%96%B0"><span class="toc-number">3.1.2.</span> <span class="toc-text">热更新</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-webpack-dev-server-%E9%85%8D%E7%BD%AE"><span class="toc-number">3.1.2.1.</span> <span class="toc-text">修改 webpack-dev-server 配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%95%E5%85%A5-react-refresh-webpack-plugin"><span class="toc-number">3.1.2.2.</span> <span class="toc-text">引入 react-refresh-webpack-plugin</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E5%BF%AB%E6%9E%84%E5%BB%BA%E9%80%9F%E5%BA%A6"><span class="toc-number">3.1.3.</span> <span class="toc-text">加快构建速度</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#cache"><span class="toc-number">3.1.3.1.</span> <span class="toc-text">cache</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%8F%E5%B0%91-loader%E3%80%81plugins"><span class="toc-number">3.1.3.2.</span> <span class="toc-text">减少 loader、plugins</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E8%B5%84%E6%BA%90"><span class="toc-number">3.1.3.2.1.</span> <span class="toc-text">管理资源</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E5%8C%96-resolve-%E9%85%8D%E7%BD%AE"><span class="toc-number">3.1.3.3.</span> <span class="toc-text">优化 resolve 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#alias"><span class="toc-number">3.1.3.3.1.</span> <span class="toc-text">alias</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#extensions"><span class="toc-number">3.1.3.3.2.</span> <span class="toc-text">extensions</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#modules"><span class="toc-number">3.1.3.4.</span> <span class="toc-text">modules</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#thread-loader"><span class="toc-number">3.1.3.5.</span> <span class="toc-text">thread-loader</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%8F%E5%B0%8F%E6%89%93%E5%8C%85%E4%BD%93%E7%A7%AF"><span class="toc-number">3.1.4.</span> <span class="toc-text">减小打包体积</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%8E%8B%E7%BC%A9"><span class="toc-number">3.1.4.1.</span> <span class="toc-text">代码压缩</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#JS-%E5%8E%8B%E7%BC%A9"><span class="toc-number">3.1.4.1.1.</span> <span class="toc-text">JS 压缩</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CSS-%E5%8E%8B%E7%BC%A9"><span class="toc-number">3.1.4.1.2.</span> <span class="toc-text">CSS 压缩</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E7%A6%BB"><span class="toc-number">3.1.4.2.</span> <span class="toc-text">代码分离</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8A%BD%E7%A6%BB%E9%87%8D%E5%A4%8D%E4%BB%A3%E7%A0%81"><span class="toc-number">3.1.4.2.1.</span> <span class="toc-text">抽离重复代码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CSS-%E6%96%87%E4%BB%B6%E5%88%86%E7%A6%BB"><span class="toc-number">3.1.4.2.2.</span> <span class="toc-text">CSS 文件分离</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%80%E5%B0%8F%E5%8C%96-entry-chunk"><span class="toc-number">3.1.4.3.</span> <span class="toc-text">最小化 entry chunk</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Tree-Shaking%EF%BC%88%E6%91%87%E6%A0%91%EF%BC%89"><span class="toc-number">3.1.4.4.</span> <span class="toc-text">Tree Shaking（摇树）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#JS"><span class="toc-number">3.1.4.4.1.</span> <span class="toc-text">JS</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#webpack5-sideEffects"><span class="toc-number">3.1.4.4.1.1.</span> <span class="toc-text">webpack5 sideEffects</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CSS"><span class="toc-number">3.1.4.4.2.</span> <span class="toc-text">CSS</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8F%92%E4%BB%B6"><span class="toc-number">4.</span> <span class="toc-text">自定义插件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%8F%92%E4%BB%B6"><span class="toc-number">4.0.1.</span> <span class="toc-text">创建插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%8F%92%E4%BB%B6%E6%9E%B6%E6%9E%84"><span class="toc-number">4.0.2.</span> <span class="toc-text">基本插件架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Compiler-%E5%92%8C-Compilation"><span class="toc-number">4.0.3.</span> <span class="toc-text">Compiler 和 Compilation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E7%BC%96%E8%AF%91%E6%8F%92%E4%BB%B6"><span class="toc-number">4.0.4.</span> <span class="toc-text">异步编译插件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#tapAsync"><span class="toc-number">4.0.4.1.</span> <span class="toc-text">tapAsync</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tapPromise"><span class="toc-number">4.0.4.2.</span> <span class="toc-text">tapPromise</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">4.0.5.</span> <span class="toc-text">示例</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">YolkPie</a></span><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">Webpack5实践与优化</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2022-07-01 10:00:00"><i class="far fa-calendar-alt fa-fw"></i> 发表于 2022-07-01</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2022-07-01 13:41:48"><i class="fas fa-history fa-fw"></i> 更新于 2022-07-01</span></time></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta__icon"></i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="Webpack5简单介绍"><a href="#Webpack5简单介绍" class="headerlink" title="Webpack5简单介绍"></a>Webpack5简单介绍</h1><p>Webpack 5 发布于 2020年10月10日，Webpack 5 对Node.js 的版本要求至少是10.13.0 (LTS)。<br>有以下特点：</p>
<ul>
<li><p>尝试用持久性缓存来提高构建性能。</p>
</li>
<li><p>尝试用更好的算法和默认值来改进长期缓存。</p>
</li>
<li><p>尝试用更好的 Tree Shaking 和代码生成来改善包大小。</p>
</li>
<li><p>尝试改善与网络平台的兼容性。</p>
</li>
<li><p>尝试在不引入任何破坏性变化的情况下，清理那些在实现 v4 功能时处于奇怪状态的内部结构。</p>
<blockquote>
<p>持久化缓存是 webpack5 所带来的非常强大的特性之一。一句话概括就是构建结果持久化缓存到本地的磁盘，二次构建(非 watch 模块)直接利用磁盘缓存的结果从而跳过构建过程当中的 resolve、build 等耗时的流程，从而大大提升编译构建的效率。</p>
</blockquote>
</li>
</ul>
<h1 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h1><h2 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h2><p>接下来一起配置一个的 Webpack5示例项目。<br>将支持以下功能：</p>
<ul>
<li>分离开发环境、生产环境配置；</li>
<li>模块化开发；</li>
<li>sourceMap 定位警告和错误；</li>
<li>动态生成引入 bundle.js 的 HTML5 文件；</li>
<li>实时编译；</li>
<li>封装编译、打包命令。</li>
</ul>
<h3 id="开始新建"><a href="#开始新建" class="headerlink" title="开始新建"></a>开始新建</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 初始化项目</span><br><span class="line">npm init -y</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 创建 src 文件夹</span><br><span class="line">mkdir src</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 创建 js文件</span><br><span class="line">touch index.js</span><br><span class="line">touch hello.js</span><br></pre></td></tr></table></figure>

<p>index.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import &#39;.&#x2F;hello.js&#39;</span><br><span class="line"></span><br><span class="line">console.log(&#39;index&#39;)</span><br></pre></td></tr></table></figure>

<p>hello.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">console.log(&#39;hello webpack&#39;)</span><br></pre></td></tr></table></figure>

<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><h4 id="node（版本有要求）"><a href="#node（版本有要求）" class="headerlink" title="node（版本有要求）"></a>node（版本有要求）</h4><h4 id="webpack"><a href="#webpack" class="headerlink" title="webpack"></a>webpack</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install webpack webpack-cli --save-dev</span><br></pre></td></tr></table></figure>
<h4 id="新建配置文件"><a href="#新建配置文件" class="headerlink" title="新建配置文件"></a>新建配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 创建 config 目录</span><br><span class="line">mkdir config</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 进入 config 目录</span><br><span class="line">cd .&#x2F;config</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 创建通用环境配置文件</span><br><span class="line">touch webpack.common.js</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 创建开发环境配置文件</span><br><span class="line">touch webpack.dev.js</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 创建生产环境配置文件</span><br><span class="line">touch webpack.prod.js</span><br></pre></td></tr></table></figure>
<h5 id="webpack-merge"><a href="#webpack-merge" class="headerlink" title="webpack-merge"></a>webpack-merge</h5><p>使用 webpack-marge 合并通用配置和特定环境配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 安装</span><br><span class="line">npm i webpack-merge -D</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; webpack.common.js通用环境配置</span><br><span class="line">module.exports &#x3D; &#123;&#125; &#x2F;&#x2F; 暂不添加配置</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; webpack.dev.js开发环境配置</span><br><span class="line">const &#123; merge &#125; &#x3D; require(&#39;webpack-merge&#39;)</span><br><span class="line">const common &#x3D; require(&#39;.&#x2F;webpack.common&#39;)</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; merge(common, &#123;&#125;) &#x2F;&#x2F; 暂不添加配置</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; webpack.prod.js生产环境配置</span><br><span class="line">const &#123; merge &#125; &#x3D; require(&#39;webpack-merge&#39;)</span><br><span class="line">const common &#x3D; require(&#39;.&#x2F;webpack.common&#39;)</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; merge(common, &#123;&#125;) &#x2F;&#x2F; 暂不添加配置</span><br></pre></td></tr></table></figure>
<h4 id="入口（entry）"><a href="#入口（entry）" class="headerlink" title="入口（entry）"></a>入口（entry）</h4><p>入口起点(entry point) 指示 webpack 应该使用哪个模块来作为构建其内部依赖图(dependency graph) 的开始。进入入口起点后，webpack会找出有哪些模块和库是入口起点（直接和间接）依赖的。</p>
<p>在此例中，使用 src/index.js 作为项目入口，webpack 以 src/index.js 为起点，查找所有依赖的模块。<br>修改 webpack.commom.js：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; merge(common, &#123;</span><br><span class="line">  &#x2F;&#x2F; 入口</span><br><span class="line">  entry: &#123;</span><br><span class="line">    index: &#39;.&#x2F;src&#x2F;index.js&#39;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="输出（output"><a href="#输出（output" class="headerlink" title="输出（output)"></a>输出（output)</h4><p>输出（output)告诉 webpack 在哪里输出它所创建的 bundle，以及如何命名这些文件。</p>
<p>生产环境的 output 需要通过 contenthash 值来区分版本和变动，可达到清缓存的效果，而本地环境为了构建效率，则不引人 contenthash。</p>
<p>新增 paths.js，封装路径方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">const fs &#x3D; require(&#39;fs&#39;)</span><br><span class="line">const path &#x3D; require(&#39;path&#39;)</span><br><span class="line"></span><br><span class="line">const appDirectory &#x3D; fs.realpathSync(process.cwd());</span><br><span class="line">const resolveApp &#x3D; relativePath &#x3D;&gt; path.resolve(appDirectory, relativePath);</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  resolveApp</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改开发环境配置文件 webpack.dev.js：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D;  merge(common, &#123;</span><br><span class="line">  &#x2F;&#x2F; 输出</span><br><span class="line">  output: &#123;</span><br><span class="line">    &#x2F;&#x2F; bundle 文件名称</span><br><span class="line">    filename: &#39;[name].bundle.js&#39;,</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; bundle 文件路径</span><br><span class="line">    path: resolveApp(&#39;dist&#39;),</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 编译前清除目录</span><br><span class="line">    clean: true</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>修改生产环境配置文件 webpack.prod.js：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D;  merge(common, &#123;</span><br><span class="line">  &#x2F;&#x2F; 输出</span><br><span class="line">  output: &#123;</span><br><span class="line">    &#x2F;&#x2F; bundle 文件名称 【只有这里和开发环境不一样】</span><br><span class="line">    filename: &#39;[name].[contenthash].bundle.js&#39;,</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; bundle 文件路径</span><br><span class="line">    path: resolveApp(&#39;dist&#39;),</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 编译前清除目录</span><br><span class="line">    clean: true</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上述 filename 的占位符解释如下</p>
</blockquote>
<ul>
<li>[name] - chunk name（例如 [name].js -&gt; app.js）。如果 chunk 没有名称，则会使用其 id 作为名称</li>
<li>[contenthash] - 输出文件内容的 md4-hash（例如 [contenthash].js -&gt; 4ea6ff1de66c537eb9b2.js）</li>
</ul>
<h4 id="模式（mode）"><a href="#模式（mode）" class="headerlink" title="模式（mode）"></a>模式（mode）</h4><p>通过 mode 配置选项，告知 webpack 使用相应模式的内置优化。<br>|选项|描述|<br>|-|-|<br>|development|会将 DefinePlugin 中 process.env.NODE_ENV 的值设置为 development. 为模块和 chunk 启用有效的名。|<br>|production|会将 DefinePlugin 中 process.env.NODE_ENV 的值设置为 production。为模块和 chunk 启用确定性的混淆名称。|</p>
<p>修改开发环境配置文件 webpack.dev.js：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D;  merge(common, &#123;</span><br><span class="line">  &#x2F;&#x2F; 开发模式</span><br><span class="line">  mode: &#39;development&#39;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>修改开发环境配置文件 webpack.prod.js：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D;  merge(common, &#123;</span><br><span class="line">  &#x2F;&#x2F; 生产模式</span><br><span class="line">  mode: &#39;production&#39;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="Source-Map"><a href="#Source-Map" class="headerlink" title="Source Map"></a>Source Map</h4><p>当 webpack 打包源代码时，可能会很难追踪到 error 和 warning 在源代码中的原始位置。</p>
<p>为了更容易地追踪 error 和 warning， source map 可以将编译后的代码映射回原始源代码。</p>
<p>修改开发环境配置文件 webpack.dev.js：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D;  merge(common, &#123;</span><br><span class="line">  &#x2F;&#x2F; 开发工具，开启 source map，编译调试</span><br><span class="line">  devtool: &#39;eval-cheap-module-source-map&#39;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>source map 还有许多其他 <a target="_blank" rel="noopener" href="https://webpack.docschina.org/configuration/devtool">可用选项</a> </p>
<blockquote>
<p>一般来说，为加快生产环境打包速度，不为生产环境配置 devtool。</p>
</blockquote>
<h4 id="HtmlWebpackPlugin"><a href="#HtmlWebpackPlugin" class="headerlink" title="HtmlWebpackPlugin"></a>HtmlWebpackPlugin</h4><p><code>npx webpack --config config/webpack.prod.js</code> 后生成了 bundle.js，我们需要一个 HTML5 文件，用来动态引入打包生成的 bundle 文件。</p>
<p>引入 HtmlWebpackPlugin 插件，生成一个 HTML5 文件， 其中包括使用 script 标签的 body 中的所有 webpack 包。</p>
<ul>
<li><p>安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev html-webpack-plugin</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改通用环境配置文件 webpack.commom.js：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  plugins: [</span><br><span class="line">    &#x2F;&#x2F; 生成html，自动引入所有bundle</span><br><span class="line">    new HtmlWebpackPlugin(&#123;</span><br><span class="line">      title: &#39;release_v0&#39;,</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>执行 <code>npx webpack --config config/webpack.prod.js</code><br>生成了 index.html，动态引入了 bundle.js 文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"> &lt;head&gt;</span><br><span class="line">  &lt;meta charset&#x3D;&quot;utf-8&quot; &#x2F;&gt;</span><br><span class="line">  &lt;title&gt;release_v0&lt;&#x2F;title&gt;</span><br><span class="line">  &lt;meta name&#x3D;&quot;viewport&quot; content&#x3D;&quot;width&#x3D;device-width,initial-scale&#x3D;1&quot; &#x2F;&gt;</span><br><span class="line">  &lt;script defer&#x3D;&quot;defer&quot; src&#x3D;&quot;index.468d741515bfc390d1ac.bundle.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line"> &lt;&#x2F;head&gt;</span><br><span class="line"> &lt;body&gt;&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>
<h4 id="DevServer"><a href="#DevServer" class="headerlink" title="DevServer"></a>DevServer</h4><p>在每次编译代码时，手动运行 npx webpack –config config/webpack.prod.js 会显得很麻烦， webpack-dev-server 帮助我们在代码发生变化后自动编译代码。</p>
<p>webpack-dev-server 提供了一个基本的 web server，并且具有实时重新加载功能。</p>
<ul>
<li><p>安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev webpack-dev-server</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改开发环境配置文件 webpack.dev.js：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; merge(common, &#123;</span><br><span class="line">  devServer: &#123;</span><br><span class="line">    &#x2F;&#x2F; 告诉服务器从哪里提供内容，只有在你想要提供静态文件时才需要。</span><br><span class="line">    contentBase: &#39;.&#x2F;dist&#39;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="执行命令"><a href="#执行命令" class="headerlink" title="执行命令"></a>执行命令</h4><p>优化 webpack 的实时编译、打包编译指令。<br>通过 cross-env 配置环境变量，区分开发环境和生产环境。</p>
<ul>
<li><p>安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev cross-env</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 package.json：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;scripts&quot;: &#123;</span><br><span class="line">        &quot;dev&quot;: &quot;cross-env NODE_ENV&#x3D;development webpack serve --open --config config&#x2F;webpack.dev.js&quot;,</span><br><span class="line">        &quot;build&quot;: &quot;cross-env NODE_ENV&#x3D;production webpack --config config&#x2F;webpack.prod.js&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p> npm run dev：本地构建</p>
</li>
<li><p> npm run build：生产打包</p>
</li>
</ul>
<p>以上我们完成了一个基于 webpack5 编译的支持模块化开发的简单项目。下面开始进阶配置。</p>
<h3 id="进阶配置"><a href="#进阶配置" class="headerlink" title="进阶配置"></a>进阶配置</h3><p>在上述配置基础上，继续配置，以实现如下功能：</p>
<ul>
<li>加载图片；</li>
<li>加载字体；</li>
<li>加载 CSS；</li>
<li>使用 SASS；</li>
<li>使用 PostCSS，并自动为 CSS 规则添加前缀，解析最新的 CSS 语法，引入 css-modules 解决全局命名冲突问题；</li>
<li>使用 React；</li>
<li>使用 TypeScript。</li>
</ul>
<h4 id="加载图片"><a href="#加载图片" class="headerlink" title="加载图片"></a>加载图片</h4><p>在 webpack 5 中，可以使用内置的 <a target="_blank" rel="noopener" href="https://webpack.docschina.org/guides/asset-modules/">资源模块（Asset Modules）</a> ，将 images 图像混入我们的系统中。</p>
<p>修改通用环境配置文件 webpack.commom.js：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">const &#123; resolveApp &#125; &#x3D; require(&#39;.&#x2F;paths&#39;);</span><br><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">    module: &#123;</span><br><span class="line">        rules: [</span><br><span class="line">          &#123;</span><br><span class="line">            test: &#x2F;\.(png|svg|jpg|jpeg|gif)$&#x2F;i,</span><br><span class="line">            include: [</span><br><span class="line">              resolveApp(&#39;src&#39;),</span><br><span class="line">            ],</span><br><span class="line">            type: &#39;asset&#x2F;resource&#39;,</span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="加载字体（Font）"><a href="#加载字体（Font）" class="headerlink" title="加载字体（Font）"></a>加载字体（Font）</h4><p>使用 <a target="_blank" rel="noopener" href="https://webpack.docschina.org/guides/asset-modules/">资源模块（Asset Modules）</a>  接收字体文件。</p>
<p>修改通用环境配置文件 webpack.commom.js：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">    module: &#123;</span><br><span class="line">        rules: [</span><br><span class="line">            &#123;</span><br><span class="line">               test: &#x2F;.(woff|woff2|eot|ttf|otf)$&#x2F;i,</span><br><span class="line">               include: [</span><br><span class="line">                  resolveApp(&#39;src&#39;),</span><br><span class="line">                ],</span><br><span class="line">               type: &#39;asset&#x2F;resource&#39;,</span><br><span class="line">             &#125;,</span><br><span class="line">         ]</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h4 id="加载-CSS"><a href="#加载-CSS" class="headerlink" title="加载 CSS"></a>加载 CSS</h4><h5 id="style-loader"><a href="#style-loader" class="headerlink" title="style-loader"></a>style-loader</h5><p>style-loader 用于将 CSS 插入到 DOM 中，通过使用多个 <style></style> 自动把 styles 插入到 DOM 中.</p>
<h5 id="css-loader"><a href="#css-loader" class="headerlink" title="css-loader"></a>css-loader</h5><p>css-loader 对 @import 和 url() 进行处理，就像 js 解析 import/require() 一样，让 CSS 也能模块化开发。</p>
<ul>
<li><p>安装相关依赖：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev style-loader css-loader</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改通用环境配置文件 webpack.commom.js：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">    module: &#123;</span><br><span class="line">        rules: [</span><br><span class="line">            &#123;</span><br><span class="line">                test: &#x2F;\.css$&#x2F;,</span><br><span class="line">                include: paths.appSrc,</span><br><span class="line">                use: [</span><br><span class="line">                  &#x2F;&#x2F; 将 JS 字符串生成为 style 节点</span><br><span class="line">                  &#39;style-loader&#39;,</span><br><span class="line">                  &#x2F;&#x2F; 将 CSS 转化成 CommonJS 模块</span><br><span class="line">                  &#39;css-loader&#39;,</span><br><span class="line">                ],</span><br><span class="line">              &#125;,</span><br><span class="line">          ]</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="使用-SASS"><a href="#使用-SASS" class="headerlink" title="使用 SASS"></a>使用 SASS</h4><h5 id="Sass"><a href="#Sass" class="headerlink" title="Sass"></a>Sass</h5><p>Sass 是一款强化 CSS 的辅助工具，它在 CSS 语法的基础上增加了变量、嵌套、混合、导入等高级功能。</p>
<h5 id="sass-loader"><a href="#sass-loader" class="headerlink" title="sass-loader"></a>sass-loader</h5><p>sass-loader 加载 Sass/SCSS 文件并将他们编译为 CSS。</p>
<ul>
<li><p>安装相关依赖：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev sass-loader sass</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改通用环境配置文件 webpack.commom.js：</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">    module: &#123;</span><br><span class="line">        rules: [</span><br><span class="line">        &#123;</span><br><span class="line">        test: &#x2F;.(scss|sass)$&#x2F;,</span><br><span class="line">        include: paths.appSrc,</span><br><span class="line">        use: [</span><br><span class="line">          &#x2F;&#x2F; 将 JS 字符串生成为 style 节点</span><br><span class="line">          &#39;style-loader&#39;,</span><br><span class="line">          &#x2F;&#x2F; 将 CSS 转化成 CommonJS 模块</span><br><span class="line">          &#39;css-loader&#39;,</span><br><span class="line">          &#x2F;&#x2F; 将 Sass 编译成 CSS</span><br><span class="line">          &#39;sass-loader&#39;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br></pre></td></tr></table></figure>

<h4 id="使用-PostCSS"><a href="#使用-PostCSS" class="headerlink" title="使用 PostCSS"></a>使用 PostCSS</h4><h5 id="PostCSS"><a href="#PostCSS" class="headerlink" title="PostCSS"></a>PostCSS</h5><p>PostCSS 是一个用 JavaScript 工具和插件转换 CSS 代码的工具。</p>
<ul>
<li>可以自动为 CSS 规则添加前缀；</li>
<li>将最新的 CSS 语法转换成大多数浏览器都能理解的语法；</li>
<li>css-modules 解决全局命名冲突问题。</li>
</ul>
<h5 id="postcss-loader"><a href="#postcss-loader" class="headerlink" title="postcss-loader"></a>postcss-loader</h5><p>postcss-loader 使用 PostCSS 处理 CSS 的 loader。</p>
<ul>
<li><p>安装相关依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev postcss-loader postcss postcss-preset-env</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改通用环境配置文件 webpack.commom.js：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">const &#123; resolveApp &#125; &#x3D; require(&#39;.&#x2F;paths&#39;);</span><br><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">    module: &#123;</span><br><span class="line">        rules: [</span><br><span class="line">          &#123;</span><br><span class="line">            test: &#x2F;\.module\.(scss|sass)$&#x2F;,</span><br><span class="line">            include: paths.appSrc,</span><br><span class="line">            use: [</span><br><span class="line">              &#x2F;&#x2F; 将 JS 字符串生成为 style 节点</span><br><span class="line">              &#39;style-loader&#39;,</span><br><span class="line">              &#x2F;&#x2F; 将 CSS 转化成 CommonJS 模块</span><br><span class="line">              &#123;</span><br><span class="line">                loader: &#39;css-loader&#39;,</span><br><span class="line">                options: &#123;</span><br><span class="line">                  &#x2F;&#x2F; Enable CSS Modules features</span><br><span class="line">                  modules: true,</span><br><span class="line">                  importLoaders: 2,</span><br><span class="line">                  &#x2F;&#x2F; 0 &#x3D;&gt; no loaders (default);</span><br><span class="line">                  &#x2F;&#x2F; 1 &#x3D;&gt; postcss-loader;</span><br><span class="line">                  &#x2F;&#x2F; 2 &#x3D;&gt; postcss-loader, sass-loader</span><br><span class="line">                &#125;,</span><br><span class="line">              &#125;,</span><br><span class="line">              &#x2F;&#x2F; 将 PostCSS 编译成 CSS</span><br><span class="line">              &#123;</span><br><span class="line">                loader: &#39;postcss-loader&#39;,</span><br><span class="line">                options: &#123;</span><br><span class="line">                  postcssOptions: &#123;</span><br><span class="line">                    plugins: [</span><br><span class="line">                      [</span><br><span class="line">                        &#x2F;&#x2F; postcss-preset-env 包含 autoprefixer</span><br><span class="line">                        &#39;postcss-preset-env&#39;,</span><br><span class="line">                      ],</span><br><span class="line">                    ],</span><br><span class="line">                  &#125;,</span><br><span class="line">                &#125;,</span><br><span class="line">              &#125;,</span><br><span class="line">              &#x2F;&#x2F; 将 Sass 编译成 CSS</span><br><span class="line">              &#39;sass-loader&#39;,</span><br><span class="line">            ],</span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<blockquote>
<p>为提升构建效率，为 loader 指定 include，通过使用 include 字段，仅将 loader 应用在实际需要将其转换的模块。</p>
</blockquote>
<h4 id="使用-React-TypeScript"><a href="#使用-React-TypeScript" class="headerlink" title="使用 React + TypeScript"></a>使用 React + TypeScript</h4><ul>
<li><p>安装 React 相关</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i react react-dom @types&#x2F;react @types&#x2F;react-dom -D</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装 TypeScript 相关：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -D typescript esbuild-loader</span><br></pre></td></tr></table></figure>

</li>
</ul>
<blockquote>
<p>为提高性能，摒弃了传统的 ts-loader，选择最新的 esbuild-loader。</p>
</blockquote>
<ul>
<li><p>修改通用环境配置文件 webpack.commom.js：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">    resolve: &#123;</span><br><span class="line">        extensions: [&#39;.tsx&#39;, &#39;.ts&#39;, &#39;.js&#39;],</span><br><span class="line">    &#125;,</span><br><span class="line">    module: &#123;</span><br><span class="line">        rules: [</span><br><span class="line">            &#123;</span><br><span class="line">                test: &#x2F;\.(js|ts|jsx|tsx)$&#x2F;,</span><br><span class="line">                include: paths.appSrc,</span><br><span class="line">                use: [</span><br><span class="line">                  &#123;</span><br><span class="line">                    loader: &#39;esbuild-loader&#39;,</span><br><span class="line">                    options: &#123;</span><br><span class="line">                      loader: &#39;tsx&#39;,</span><br><span class="line">                      target: &#39;es2015&#39;,</span><br><span class="line">                    &#125;,</span><br><span class="line">                  &#125;</span><br><span class="line">                ]</span><br><span class="line">              &#125;,</span><br><span class="line">         ]</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>TypeScript 是 JavaScript 的超集，为其增加了类型系统，可以编译为普通 JavaScript 代码。</p>
<p>为兼容 TypeScript 文件，新增 typescript 配置文件 tsconfig.json：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;compilerOptions&quot;: &#123;</span><br><span class="line">        &quot;outDir&quot;: &quot;.&#x2F;dist&#x2F;&quot;,</span><br><span class="line">        &quot;noImplicitAny&quot;: true,</span><br><span class="line">        &quot;module&quot;: &quot;es6&quot;,</span><br><span class="line">        &quot;target&quot;: &quot;es5&quot;,</span><br><span class="line">        &quot;jsx&quot;: &quot;react&quot;,</span><br><span class="line">        &quot;allowJs&quot;: true,</span><br><span class="line">        &quot;moduleResolution&quot;: &quot;node&quot;,</span><br><span class="line">        &quot;allowSyntheticDefaultImports&quot;: true,</span><br><span class="line">        &quot;esModuleInterop&quot;: true,</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h1><ul>
<li>开发体验</li>
<li>加快编译速度</li>
<li>减小打包体积</li>
</ul>
<h2 id="开发体验"><a href="#开发体验" class="headerlink" title="开发体验"></a>开发体验</h2><h3 id="自动更新"><a href="#自动更新" class="headerlink" title="自动更新"></a>自动更新</h3><p>自动更新：在开发过程中，修改代码后，无需手动再次编译，可以自动编译代码更新编译后代码的功能。</p>
<p>webpack5 提供了以下几种可选方式，来实现自动更新功能：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://webpack.docschina.org/configuration/watch/#watch">webpack’s Watch Mode</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/webpack/webpack-dev-server">webpack-dev-server</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/webpack/webpack-dev-middleware">webpack-dev-middleware</a><br>官方推荐的方式是 webpack-dev-server，前面已经介绍了 webpack-dev-server 帮助我们在代码发生变化后自动编译代码实现自动更新的用法，在这里不重复赘述。</li>
</ul>
<h3 id="热更新"><a href="#热更新" class="headerlink" title="热更新"></a>热更新</h3><p>热更新：在开发过程中，修改代码后，仅更新修改部分的内容，无需刷新整个页面。</p>
<h4 id="修改-webpack-dev-server-配置"><a href="#修改-webpack-dev-server-配置" class="headerlink" title="修改 webpack-dev-server 配置"></a>修改 webpack-dev-server 配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">module.export &#x3D; &#123;</span><br><span class="line">    devServer: &#123;</span><br><span class="line">        contentBase: &#39;.&#x2F;dist&#39;,</span><br><span class="line">        hot: true, &#x2F;&#x2F; 热更新</span><br><span class="line">      &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="引入-react-refresh-webpack-plugin"><a href="#引入-react-refresh-webpack-plugin" class="headerlink" title="引入 react-refresh-webpack-plugin"></a>引入 react-refresh-webpack-plugin</h4><ul>
<li><p>安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -D @pmmmwh&#x2F;react-refresh-webpack-plugin react-refresh</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 webpack.dev.js 配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">const ReactRefreshWebpackPlugin &#x3D; require(&#39;@pmmmwh&#x2F;react-refresh-webpack-plugin&#39;);</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">    plugins: [</span><br><span class="line">        new webpack.HotModuleReplacementPlugin(),</span><br><span class="line">        new ReactRefreshWebpackPlugin(),</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="加快构建速度"><a href="#加快构建速度" class="headerlink" title="加快构建速度"></a>加快构建速度</h3><p>webpack5 较于 webpack4，新增了<font color="red">持久化缓存、改进缓存算法</font>等优化，较之前版本构建速度已有不错的提升。</p>
<h4 id="cache"><a href="#cache" class="headerlink" title="cache"></a>cache</h4><p>通过配置 <a target="_blank" rel="noopener" href="https://webpack.docschina.org/configuration/cache/#root">webpack 持久化缓存</a> cache: filesystem，来缓存生成的 webpack 模块和 chunk，改善构建速度。</p>
<p>简单来说，通过 cache: filesystem 可以将构建过程的 webpack 模板进行缓存，大幅提升二次构建速度、打包速度，当构建突然中断，二次进行构建时，可以直接从缓存中拉取，因而提升构建速度。</p>
<h4 id="减少-loader、plugins"><a href="#减少-loader、plugins" class="headerlink" title="减少 loader、plugins"></a>减少 loader、plugins</h4><p>为 loader 指定 include，减少 loader 应用范围，仅应用于最少数量的必要模块，来提升<a target="_blank" rel="noopener" href="https://webpack.docschina.org/guides/build-performance/">webpack构建性能</a></p>
<p>webpack.common.js 配置方式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">    rules: [</span><br><span class="line">        &#123;</span><br><span class="line">            test: &#x2F;\.(js|ts|jsx|tsx)$&#x2F;,</span><br><span class="line">            include: paths.appSrc,</span><br><span class="line">            use: [</span><br><span class="line">              &#123;</span><br><span class="line">                loader: &#39;esbuild-loader&#39;,</span><br><span class="line">                options: &#123;</span><br><span class="line">                  loader: &#39;tsx&#39;,</span><br><span class="line">                  target: &#39;es2015&#39;,</span><br><span class="line">                &#125;,</span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">         &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>rule.exclude 可以排除模块范围，也可用于减少 loader 应用范围。</p>
</blockquote>
<h5 id="管理资源"><a href="#管理资源" class="headerlink" title="管理资源"></a>管理资源</h5><p>使用 webpack 资源模块 (asset module) 代替旧的 assets loader（如 file-loader/url-loader/raw-loader 等），减少 loader 配置数量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">    rules: [</span><br><span class="line">       &#123;</span><br><span class="line">        test: &#x2F;\.(png|svg|jpg|jpeg|gif)$&#x2F;i,</span><br><span class="line">        include: [</span><br><span class="line">          paths.appSrc,</span><br><span class="line">        ],</span><br><span class="line">        type: &#39;asset&#x2F;resource&#39;,</span><br><span class="line">      &#125;,</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="优化-resolve-配置"><a href="#优化-resolve-配置" class="headerlink" title="优化 resolve 配置"></a>优化 resolve 配置</h4><p><a target="_blank" rel="noopener" href="https://webpack.docschina.org/configuration/resolve/#root">resolve</a> 用来配置 webpack 如何解析模块，可通过优化 resolve 配置来覆盖默认配置项，减少解析范围。</p>
<h5 id="alias"><a href="#alias" class="headerlink" title="alias"></a>alias</h5><p>alias 可以创建 import 或 require 的别名，用来简化模块引入。<br>webpack.common.js 配置方式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">    resolve: &#123;</span><br><span class="line">        alias: &#123;</span><br><span class="line">          &#39;@&#39;: paths.appSrc, &#x2F;&#x2F; @ 代表 src 路径</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="extensions"><a href="#extensions" class="headerlink" title="extensions"></a>extensions</h5><p>extensions 表示需要解析的文件类型列表。</p>
<p>根据项目中的文件类型，定义 extensions，以覆盖 webpack 默认的 extensions，加快解析速度。</p>
<p>由于 <font color='red'>webpack 的解析顺序是从左到右</font>，因此要将使用频率高的文件类型放在左侧，如下我将 tsx 放在最左侧。</p>
<p>webpack.common.js 配置方式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">    resolve: &#123;</span><br><span class="line">        extensions: [&#39;.tsx&#39;, &#39;.js&#39;], &#x2F;&#x2F; 这里只是举例，如果有其他类型，需要按顺序添加进去。</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="modules"><a href="#modules" class="headerlink" title="modules"></a>modules</h4><p>modules 表示 webpack 解析模块时需要解析的目录。</p>
<p>指定目录可缩小 webpack 解析范围，加快构建速度。<br>webpack.common.js 配置方式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">    modules: [</span><br><span class="line">      &#39;node_modules&#39;, &#x2F;&#x2F;这里只是举例说明</span><br><span class="line">       paths.appSrc,</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="thread-loader"><a href="#thread-loader" class="headerlink" title="thread-loader"></a>thread-loader</h4><p>通过 <a target="_blank" rel="noopener" href="https://webpack.docschina.org/loaders/thread-loader/#root">thread-loader</a> 将耗时的 loader 放在一个独立的 worker 池中运行，加快 loader 构建速度。</p>
<ul>
<li><p>安装：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -D thread-loader</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>webpack.common.js 配置方式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">    rules: [</span><br><span class="line">        &#123;</span><br><span class="line">        test: &#x2F;\.module\.(scss|sass)$&#x2F;,</span><br><span class="line">        include: paths.appSrc,</span><br><span class="line">        use: [</span><br><span class="line">          &#39;style-loader&#39;,</span><br><span class="line">          &#123;</span><br><span class="line">            loader: &#39;css-loader&#39;,</span><br><span class="line">            options: &#123;</span><br><span class="line">              modules: true,</span><br><span class="line">              importLoaders: 2,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            loader: &#39;postcss-loader&#39;,</span><br><span class="line">            options: &#123;</span><br><span class="line">              postcssOptions: &#123;</span><br><span class="line">                plugins: [</span><br><span class="line">                  [</span><br><span class="line">                    &#39;postcss-preset-env&#39;,</span><br><span class="line">                  ],</span><br><span class="line">                ],</span><br><span class="line">              &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            loader: &#39;thread-loader&#39;,</span><br><span class="line">            options: &#123;</span><br><span class="line">              workerParallelJobs: 2</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &#39;sass-loader&#39;,</span><br><span class="line">        ].filter(Boolean),</span><br><span class="line">      &#125;,</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>webpack 官网 提到 node-sass 中有个来自 Node.js 线程池的阻塞线程的 bug。 当使用 thread-loader 时，需要设置 workerParallelJobs: 2。</p>
</blockquote>
<blockquote>
<p>应该仅在非常耗时的 loader 前引入 thread-loader，如果代码量比较小，滥用thread-loader，反而会影响构建速度。</p>
</blockquote>
<h3 id="减小打包体积"><a href="#减小打包体积" class="headerlink" title="减小打包体积"></a>减小打包体积</h3><h4 id="代码压缩"><a href="#代码压缩" class="headerlink" title="代码压缩"></a>代码压缩</h4><p>通过 webpack 插件，将 JS、CSS 等文件进行压缩。</p>
<h5 id="JS-压缩"><a href="#JS-压缩" class="headerlink" title="JS 压缩"></a>JS 压缩</h5><p>使用 <a target="_blank" rel="noopener" href="https://webpack.docschina.org/plugins/terser-webpack-plugin/">TerserWebpackPlugin</a> 来压缩 JavaScript。</p>
<p>webpack5 自带最新的 terser-webpack-plugin，无需手动安装。</p>
<blockquote>
<p>terser-webpack-plugin 默认开启了 parallel: true 配置，并发运行的默认数量： os.cpus().length - 1 ，本文配置的 parallel 数量为 4，使用多进程并发运行压缩以提高构建速度。</p>
</blockquote>
<p>webpack.prod.js 配置方式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">const TerserPlugin &#x3D; require(&#39;terser-webpack-plugin&#39;);</span><br><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">    optimization: &#123;</span><br><span class="line">        minimizer: [</span><br><span class="line">            new TerserPlugin(&#123;</span><br><span class="line">              parallel: 4,</span><br><span class="line">              terserOptions: &#123;</span><br><span class="line">                parse: &#123;</span><br><span class="line">                  ecma: 8,</span><br><span class="line">                &#125;,</span><br><span class="line">                compress: &#123;</span><br><span class="line">                  ecma: 5,</span><br><span class="line">                  warnings: false,</span><br><span class="line">                  comparisons: false,</span><br><span class="line">                  inline: 2,</span><br><span class="line">                &#125;,</span><br><span class="line">                mangle: &#123;</span><br><span class="line">                  safari10: true,</span><br><span class="line">                &#125;,</span><br><span class="line">                output: &#123;</span><br><span class="line">                  ecma: 5,</span><br><span class="line">                  comments: false,</span><br><span class="line">                  ascii_only: true,</span><br><span class="line">                &#125;,</span><br><span class="line">              &#125;,</span><br><span class="line">            &#125;),</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="CSS-压缩"><a href="#CSS-压缩" class="headerlink" title="CSS 压缩"></a>CSS 压缩</h5><p>使用 <a target="_blank" rel="noopener" href="https://webpack.docschina.org/plugins/css-minimizer-webpack-plugin/#root">CssMinimizerWebpackPlugin</a> 压缩 CSS 文件。</p>
<ul>
<li><p>安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -D css-minimizer-webpack-plugin</span><br></pre></td></tr></table></figure>
</li>
<li><p>webpack.prod.js 配置方式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">const CssMinimizerPlugin &#x3D; require(&quot;css-minimizer-webpack-plugin&quot;);</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  optimization: &#123;</span><br><span class="line">    minimizer: [</span><br><span class="line">      new CssMinimizerPlugin(&#123;</span><br><span class="line">          parallel: 4,</span><br><span class="line">        &#125;),</span><br><span class="line">    ],</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="代码分离"><a href="#代码分离" class="headerlink" title="代码分离"></a>代码分离</h4><p>代码分离能够把代码分离到不同的 bundle 中，然后可以按需加载或并行加载这些文件。</p>
<h5 id="抽离重复代码"><a href="#抽离重复代码" class="headerlink" title="抽离重复代码"></a>抽离重复代码</h5><p><a target="_blank" rel="noopener" href="https://webpack.docschina.org/plugins/split-chunks-plugin">SplitChunksPlugin</a> 插件，可以将公共的依赖模块提取到已有的入口 chunk 中，或者提取到一个新生成的 chunk。</p>
<p>webpack 将根据以下条件自动拆分 chunks：</p>
<ul>
<li>新的 chunk 可以被共享，或者模块来自于 node_modules 文件夹；</li>
<li>新的 chunk 体积大于 20kb（在进行 min+gz 之前的体积）；</li>
<li>当按需加载 chunks 时，并行请求的最大数量小于或等于 30；</li>
<li>当加载初始化页面时，并发请求的最大数量小于或等于 30； 通过 splitChunks 把 react 等公共库抽离出来，不重复引入占用体积。</li>
</ul>
<blockquote>
<p>注意：切记不要为 cacheGroups 定义固定的 name，因为  cacheGroups.name  指定字符串或始终返回相同字符串的函数时，会将所有常见模块和 vendor 合并为一个 chunk。这会导致更大的初始下载量并减慢页面加载速度。</p>
</blockquote>
<p>webpack.prod.js 配置方式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">    splitChunks: &#123;</span><br><span class="line">      &#x2F;&#x2F; include all types of chunks</span><br><span class="line">      chunks: &#39;all&#39;,</span><br><span class="line">      &#x2F;&#x2F; 重复打包问题</span><br><span class="line">      cacheGroups:&#123;</span><br><span class="line">        vendors:&#123; &#x2F;&#x2F; node_modules里的代码</span><br><span class="line">          test: &#x2F;[\\&#x2F;]node_modules[\\&#x2F;]&#x2F;,</span><br><span class="line">          chunks: &quot;all&quot;,</span><br><span class="line">          &#x2F;&#x2F; name: &#39;vendors&#39;, 一定不要定义固定的name</span><br><span class="line">          priority: 10, &#x2F;&#x2F; 优先级</span><br><span class="line">          enforce: true </span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样即将公共的模块单独打包，不再重复引入了。</p>
<h5 id="CSS-文件分离"><a href="#CSS-文件分离" class="headerlink" title="CSS 文件分离"></a>CSS 文件分离</h5><p>如果 CSS 是放在 JS 文件中，<a target="_blank" rel="noopener" href="https://webpack.docschina.org/plugins/mini-css-extract-plugin/">MiniCssExtractPlugin</a> 插件将 CSS 提取到单独的文件中，为每个包含 CSS 的 JS 文件创建一个 CSS 文件，并且支持 CSS 和 SourceMaps 的按需加载。</p>
<ul>
<li><p>安装：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -D mini-css-extract-plugin</span><br></pre></td></tr></table></figure>
</li>
<li><p>webpack.common.js 配置方式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">const MiniCssExtractPlugin &#x3D; require(&quot;mini-css-extract-plugin&quot;);</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  plugins: [new MiniCssExtractPlugin()],</span><br><span class="line">  module: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">        &#123;</span><br><span class="line">        test: &#x2F;\.module\.(scss|sass)$&#x2F;,</span><br><span class="line">        include: paths.appSrc,</span><br><span class="line">        use: [</span><br><span class="line">          &#39;style-loader&#39;,</span><br><span class="line">          isEnvProduction &amp;&amp; MiniCssExtractPlugin.loader, &#x2F;&#x2F; 仅生产环境</span><br><span class="line">          &#123;</span><br><span class="line">            loader: &#39;css-loader&#39;,</span><br><span class="line">            options: &#123;</span><br><span class="line">              modules: true,</span><br><span class="line">              importLoaders: 2,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            loader: &#39;postcss-loader&#39;,</span><br><span class="line">            options: &#123;</span><br><span class="line">              postcssOptions: &#123;</span><br><span class="line">                plugins: [</span><br><span class="line">                  [</span><br><span class="line">                    &#39;postcss-preset-env&#39;,</span><br><span class="line">                  ],</span><br><span class="line">                ],</span><br><span class="line">              &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            loader: &#39;thread-loader&#39;,</span><br><span class="line">            options: &#123;</span><br><span class="line">              workerParallelJobs: 2</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &#39;sass-loader&#39;,</span><br><span class="line">        ].filter(Boolean),</span><br><span class="line">      &#125;,</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<blockquote>
<p>注意：MiniCssExtractPlugin.loader 一定要放在 style-loader 后面。</p>
</blockquote>
<h4 id="最小化-entry-chunk"><a href="#最小化-entry-chunk" class="headerlink" title="最小化 entry chunk"></a>最小化 entry chunk</h4><p>通过配置 optimization.runtimeChunk = true，为运行时代码创建一个额外的 chunk，减少 entry chunk 体积，提高性能。</p>
<p>webpack.prod.js 配置方式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">    optimization: &#123;</span><br><span class="line">        runtimeChunk: true,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Tree-Shaking（摇树）"><a href="#Tree-Shaking（摇树）" class="headerlink" title="Tree Shaking（摇树）"></a>Tree Shaking（摇树）</h4><p>摇树，就是将枯黄的落叶摇下来，只留下树上活的叶子。枯黄的落叶代表项目中未引用的无用代码，活的树叶代表项目中实际用到的源码。</p>
<h5 id="JS"><a href="#JS" class="headerlink" title="JS"></a>JS</h5><p><a target="_blank" rel="noopener" href="https://webpack.docschina.org/guides/tree-shaking/">JS Tree Shaking</a> 将 JavaScript 上下文中的未引用代码（Dead Code）移除，通过 package.json 的 “sideEffects” 属性作为标记，向 compiler 提供提示，表明项目中的哪些文件是 “pure(纯正 ES2015 模块)”，由此可以安全地删除文件中未使用的部分。</p>
<h6 id="webpack5-sideEffects"><a href="#webpack5-sideEffects" class="headerlink" title="webpack5 sideEffects"></a>webpack5 sideEffects</h6><p>通过 package.json 的 “sideEffects” 属性，来实现这种方式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;your-project&quot;,</span><br><span class="line">  &quot;sideEffects&quot;: false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需注意的是，当代码有副作用时，需要将 sideEffects 改为提供一个数组，添加有副作用代码的文件路径：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;your-project&quot;,</span><br><span class="line">  &quot;sideEffects&quot;: [&quot;.&#x2F;src&#x2F;some-side-effectful-file.js&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="CSS"><a href="#CSS" class="headerlink" title="CSS"></a>CSS</h5><p>使用 <a target="_blank" rel="noopener" href="https://github.com/FullHuman/purgecss/tree/main/packages/purgecss-webpack-plugin">purgecss-webpack-plugin</a> 对 CSS Tree Shaking。</p>
<ul>
<li><p>安装：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i purgecss-webpack-plugin -D</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>因为打包时 CSS 默认放在 JS 文件内，因此要结合 webpack 分离 CSS 文件插件 mini-css-extract-plugin 一起使用，先将 CSS 文件分离，再进行 CSS Tree Shaking。</p>
<p>webpack.prod.js 配置方式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">const glob &#x3D; require(&#39;glob&#39;)</span><br><span class="line">const MiniCssExtractPlugin &#x3D; require(&#39;mini-css-extract-plugin&#39;)</span><br><span class="line">const PurgeCSSPlugin &#x3D; require(&#39;purgecss-webpack-plugin&#39;)</span><br><span class="line">const paths &#x3D; require(&#39;paths&#39;)</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  plugins: [</span><br><span class="line">    &#x2F;&#x2F; 打包体积分析</span><br><span class="line">    new BundleAnalyzerPlugin(),</span><br><span class="line">    &#x2F;&#x2F; 提取 CSS</span><br><span class="line">    new MiniCssExtractPlugin(&#123;</span><br><span class="line">      filename: &quot;[name].css&quot;,</span><br><span class="line">    &#125;),</span><br><span class="line">    &#x2F;&#x2F; CSS Tree Shaking</span><br><span class="line">    new PurgeCSSPlugin(&#123;</span><br><span class="line">      paths: glob.sync(&#96;$&#123;paths.appSrc&#125;&#x2F;**&#x2F;*&#96;,  &#123; nodir: true &#125;),</span><br><span class="line">    &#125;),</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="自定义插件"><a href="#自定义插件" class="headerlink" title="自定义插件"></a>自定义插件</h1><p>插件向第三方开发者提供了 webpack 引擎中完整的能力。使用阶段式的构建回调，开发者可以在 webpack 构建流程中引入自定义的行为。</p>
<h3 id="创建插件"><a href="#创建插件" class="headerlink" title="创建插件"></a>创建插件</h3><p>webpack 插件由以下组成：</p>
<ul>
<li>一个 JavaScript 命名函数或 JavaScript 类。</li>
<li>在插件函数的 prototype 上定义一个 apply 方法。</li>
<li>指定一个绑定到 webpack 自身的事件钩子。</li>
<li>处理 webpack 内部实例的特定数据。</li>
<li>功能完成后调用 webpack 提供的回调。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 一个 JavaScript 类</span><br><span class="line">class MyExampleWebpackPlugin &#123;</span><br><span class="line">  &#x2F;&#x2F; 在插件函数的 prototype 上定义一个 &#96;apply&#96; 方法，以 compiler 为参数。</span><br><span class="line">  apply(compiler) &#123;</span><br><span class="line">    &#x2F;&#x2F; 指定一个挂载到 webpack 自身的事件钩子。</span><br><span class="line">    compiler.hooks.emit.tapAsync(</span><br><span class="line">      &#39;MyExampleWebpackPlugin&#39;,</span><br><span class="line">      (compilation, callback) &#x3D;&gt; &#123;</span><br><span class="line">        console.log(&#39;这是一个示例插件！&#39;);</span><br><span class="line">        console.log(</span><br><span class="line">          &#39;这里表示了资源的单次构建的 &#96;compilation&#96; 对象：&#39;,</span><br><span class="line">          compilation</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 用 webpack 提供的插件 API 处理构建过程</span><br><span class="line">        compilation.addModule(&#x2F;* ... *&#x2F;);</span><br><span class="line"></span><br><span class="line">        callback();</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="基本插件架构"><a href="#基本插件架构" class="headerlink" title="基本插件架构"></a>基本插件架构</h3><p>插件是由「具有 apply 方法的 prototype 对象」所实例化出来的。这个 apply 方法在安装插件时，会被 webpack compiler 调用一次。apply 方法可以接收一个 webpack compiler 对象的引用，从而可以在回调函数中访问到 compiler 对象。一个插件结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class HelloWorldPlugin &#123;</span><br><span class="line">  apply(compiler) &#123;</span><br><span class="line">    compiler.hooks.done.tap(</span><br><span class="line">      &#39;Hello World Plugin&#39;,</span><br><span class="line">      (</span><br><span class="line">        stats &#x2F;* 绑定 done 钩子后，stats 会作为参数传入。 *&#x2F;</span><br><span class="line">      ) &#x3D;&gt; &#123;</span><br><span class="line">        console.log(&#39;Hello World!&#39;);</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; HelloWorldPlugin;</span><br></pre></td></tr></table></figure>

<p>然后，要安装这个插件，只需要在你的 webpack 配置的 plugin 数组中添加一个实例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; webpack.config.js</span><br><span class="line">var HelloWorldPlugin &#x3D; require(&#39;hello-world&#39;);</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  &#x2F;&#x2F; ... 这里是其他配置 ...</span><br><span class="line">  plugins: [new HelloWorldPlugin(&#123; options: true &#125;)],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="Compiler-和-Compilation"><a href="#Compiler-和-Compilation" class="headerlink" title="Compiler 和 Compilation"></a>Compiler 和 Compilation</h3><p>在插件开发中最重要的两个资源就是 <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_40409143/article/details/123663207">compiler</a> 和 <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_34293911/article/details/88675677">compilation</a> 对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">class HelloCompilationPlugin &#123;</span><br><span class="line">  apply(compiler) &#123;</span><br><span class="line">    &#x2F;&#x2F; 指定一个挂载到 compilation 的钩子，回调函数的参数为 compilation 。</span><br><span class="line">    compiler.hooks.compilation.tap(&#39;HelloCompilationPlugin&#39;, (compilation) &#x3D;&gt; &#123;</span><br><span class="line">      &#x2F;&#x2F; 现在可以通过 compilation 对象绑定各种钩子</span><br><span class="line">      compilation.hooks.optimize.tap(&#39;HelloCompilationPlugin&#39;, () &#x3D;&gt; &#123;</span><br><span class="line">        console.log(&#39;资源已经优化完毕。&#39;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; HelloCompilationPlugin;</span><br></pre></td></tr></table></figure>

<h3 id="异步编译插件"><a href="#异步编译插件" class="headerlink" title="异步编译插件"></a>异步编译插件</h3><p>有些插件钩子是异步的。我们可以像同步方式一样用 tap 方法来绑定，也可以用 tapAsync 或 tapPromise 这两个异步方法来绑定。</p>
<h4 id="tapAsync"><a href="#tapAsync" class="headerlink" title="tapAsync"></a>tapAsync</h4><p>当我们用 tapAsync 方法来绑定插件时，_必须_调用函数的最后一个参数 callback 指定的回调函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">class HelloAsyncPlugin &#123;</span><br><span class="line">  apply(compiler) &#123;</span><br><span class="line">    compiler.hooks.emit.tapAsync(</span><br><span class="line">      &#39;HelloAsyncPlugin&#39;,</span><br><span class="line">      (compilation, callback) &#x3D;&gt; &#123;</span><br><span class="line">        &#x2F;&#x2F; 执行某些异步操作...</span><br><span class="line">        setTimeout(function () &#123;</span><br><span class="line">          console.log(&#39;异步任务完成...&#39;);</span><br><span class="line">          callback();</span><br><span class="line">        &#125;, 1000);</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; HelloAsyncPlugin;</span><br></pre></td></tr></table></figure>

<h4 id="tapPromise"><a href="#tapPromise" class="headerlink" title="tapPromise"></a>tapPromise</h4><p>当我们用 tapPromise 方法来绑定插件时，_必须_返回一个 pormise ，异步任务完成后 resolve 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">class HelloAsyncPlugin &#123;</span><br><span class="line">  apply(compiler) &#123;</span><br><span class="line">    compiler.hooks.emit.tapPromise(&#39;HelloAsyncPlugin&#39;, (compilation) &#x3D;&gt; &#123;</span><br><span class="line">      &#x2F;&#x2F; 返回一个 pormise ，异步任务完成后 resolve</span><br><span class="line">      return new Promise((resolve, reject) &#x3D;&gt; &#123;</span><br><span class="line">        setTimeout(function () &#123;</span><br><span class="line">          console.log(&#39;异步任务完成...&#39;);</span><br><span class="line">          resolve();</span><br><span class="line">        &#125;, 1000);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; HelloAsyncPlugin;</span><br></pre></td></tr></table></figure>

<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><p>一个简单的示例插件，生成一个叫做 assets.md 的新文件；文件内容是所有构建生成的文件的列表。这个插件大概像下面这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">class FileListPlugin &#123;</span><br><span class="line">  static defaultOptions &#x3D; &#123;</span><br><span class="line">    outputFile: &#39;assets.md&#39;,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 需要传入自定义插件构造函数的任意选项</span><br><span class="line">  &#x2F;&#x2F;（这是自定义插件的公开API）</span><br><span class="line">  constructor(options &#x3D; &#123;&#125;) &#123;</span><br><span class="line">    &#x2F;&#x2F; 在应用默认选项前，先应用用户指定选项</span><br><span class="line">    &#x2F;&#x2F; 合并后的选项暴露给插件方法</span><br><span class="line">    &#x2F;&#x2F; 记得在这里校验所有选项</span><br><span class="line">    this.options &#x3D; &#123; ...FileListPlugin.defaultOptions, ...options &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  apply(compiler) &#123;</span><br><span class="line">    const pluginName &#x3D; FileListPlugin.name;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; webpack 模块实例，可以通过 compiler 对象访问，</span><br><span class="line">    &#x2F;&#x2F; 这样确保使用的是模块的正确版本</span><br><span class="line">    &#x2F;&#x2F; （不要直接 require&#x2F;import webpack）</span><br><span class="line">    const &#123; webpack &#125; &#x3D; compiler;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Compilation 对象提供了对一些有用常量的访问。</span><br><span class="line">    const &#123; Compilation &#125; &#x3D; webpack;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; RawSource 是其中一种 “源码”(&quot;sources&quot;) 类型，</span><br><span class="line">    &#x2F;&#x2F; 用来在 compilation 中表示资源的源码</span><br><span class="line">    const &#123; RawSource &#125; &#x3D; webpack.sources;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 绑定到 “thisCompilation” 钩子，</span><br><span class="line">    &#x2F;&#x2F; 以便进一步绑定到 compilation 过程更早期的阶段</span><br><span class="line">    compiler.hooks.thisCompilation.tap(pluginName, (compilation) &#x3D;&gt; &#123;</span><br><span class="line">      &#x2F;&#x2F; 绑定到资源处理流水线(assets processing pipeline)</span><br><span class="line">      compilation.hooks.processAssets.tap(</span><br><span class="line">        &#123;</span><br><span class="line">          name: pluginName,</span><br><span class="line"></span><br><span class="line">          &#x2F;&#x2F; 用某个靠后的资源处理阶段，</span><br><span class="line">          &#x2F;&#x2F; 确保所有资源已被插件添加到 compilation</span><br><span class="line">          stage: Compilation.PROCESS_ASSETS_STAGE_SUMMARIZE,</span><br><span class="line">        &#125;,</span><br><span class="line">        (assets) &#x3D;&gt; &#123;</span><br><span class="line">          &#x2F;&#x2F; &quot;assets&quot; 是一个包含 compilation 中所有资源(assets)的对象。</span><br><span class="line">          &#x2F;&#x2F; 该对象的键是资源的路径，</span><br><span class="line">          &#x2F;&#x2F; 值是文件的源码</span><br><span class="line"></span><br><span class="line">          &#x2F;&#x2F; 遍历所有资源，</span><br><span class="line">          &#x2F;&#x2F; 生成 Markdown 文件的内容</span><br><span class="line">          const content &#x3D;</span><br><span class="line">            &#39;# In this build:\n\n&#39; +</span><br><span class="line">            Object.keys(assets)</span><br><span class="line">              .map((filename) &#x3D;&gt; &#96;- $&#123;filename&#125;&#96;)</span><br><span class="line">              .join(&#39;\n&#39;);</span><br><span class="line"></span><br><span class="line">          &#x2F;&#x2F; 向 compilation 添加新的资源，</span><br><span class="line">          &#x2F;&#x2F; 这样 webpack 就会自动生成并输出到 output 目录</span><br><span class="line">          compilation.emitAsset(</span><br><span class="line">            this.options.outputFile,</span><br><span class="line">            new RawSource(content)</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      );</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; &#123; FileListPlugin &#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;webpack.config.js</span><br><span class="line">const &#123; FileListPlugin &#125; &#x3D; require(&#39;.&#x2F;file-list-plugin.js&#39;);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 在 webpack 配置中使用自定义的插件：</span><br><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  &#x2F;&#x2F; …</span><br><span class="line"></span><br><span class="line">  plugins: [</span><br><span class="line">    &#x2F;&#x2F; 添加插件，使用默认选项</span><br><span class="line">    new FileListPlugin(),</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 或者:</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 使用任意支持的选项</span><br><span class="line">    new FileListPlugin(&#123;</span><br><span class="line">      outputFile: &#39;my-assets.md&#39;,</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">YolkPie</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://yolkpie.net/2022/07/01/Webpack5%E5%AE%9E%E8%B7%B5%E4%B8%8E%E4%BC%98%E5%8C%96/">https://yolkpie.net/2022/07/01/Webpack5%E5%AE%9E%E8%B7%B5%E4%B8%8E%E4%BC%98%E5%8C%96/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://yolkpie.net" target="_blank">YolkPie</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/07/01/%E8%AE%BE%E8%AE%A1%E5%B8%88%E5%9F%B9%E5%85%BB%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%80%83%E8%83%BD%E5%8A%9B/"><img class="prev-cover" data-src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">设计师培养设计思考能力</div></div></a></div><div class="next-post pull-right"><a href="/2022/06/29/JS%E5%86%85%E5%AD%98/"><img class="next-cover" data-src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">js内存</div></div></a></div></nav></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By YolkPie</div><div class="framework-info"><span>驱动 </span><a target="_blank" rel="noopener" href="https://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><button id="readmode" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" title="缩小字体"><i class="fas fa-minus"></i></button><button class="translate_chn_to_cht" id="translateLink" title="简繁转换">繁</button><button id="darkmode" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script></body></html>